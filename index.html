<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FaceLens Live</title>

  <!-- MediaPipe -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <style>
    body { margin:0; background:#0f0f0f; color:#fff; font-family:Arial }
    #container { position:relative; width:100vw; height:100vh }
    video, canvas { position:absolute; width:100%; height:100%; object-fit:cover }
    #ui { position:fixed; bottom:0; left:0; right:0; padding:12px; background:rgba(0,0,0,.6) }
    button { padding:10px; border:none; border-radius:10px; font-weight:bold; cursor:pointer }
    button.secondary { background:#333; color:#fff }
    button.hidden { display:none }
  </style>
</head>

<body>

<div id="ui">
  <!-- Filtro -->
  <div style="margin-bottom:10px;">
    <select id="categoryFilter" class="secondary" style="
      width:100%;
      padding:10px 12px;
      border:none;
      border-radius:10px;
      background:#333;
      color:#fff;
      font-weight:bold;
      outline:none;
    ">
      <option value="all">Todos</option>
      <option value="clasicos">ClÃ¡sicos</option>
      <option value="degrade">DegradÃ©</option>
      <option value="espejados">Espejados</option>
      <option value="polarizados">Polarizados</option>
      <option value="ferrari">Ferrari</option>
    </select>
  </div>

  <!-- NavegaciÃ³n -->
  <div style="display:flex; align-items:center; gap:10px;">
    <button id="prevBtn" class="secondary" style="min-width:44px;">â—€</button>

    <span id="modelName" style="
      flex:1;
      text-align:center;
      font-weight:bold;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    ">Cargandoâ€¦</span>

    <button id="nextBtn" class="secondary" style="min-width:44px;">â–¶</button>
  </div>

  <!-- Acciones -->
  <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
    <button id="captureBtn" class="secondary">ðŸ“¸ Captura</button>
    <button id="productBtn" class="hidden">ðŸ›’ Producto</button>
  </div>
</div>

/* =========================
   1) Slug
========================= */
const slug =
  new URLSearchParams(location.search).get("slug") ||
  location.pathname.replace("/", "") ||
  "tienda24x7_demo";

/* =========================
   2) Estado
========================= */
let cliente = null;
let lentes = [];
let currentIndex = 0;
let lensImg = new Image();
let lensReady = false;

/* =========================
   3) UI
========================= */
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const modelNameEl = document.getElementById("modelName");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const captureBtn = document.getElementById("captureBtn");
const productBtn = document.getElementById("productBtn");

/** =========================
 *  4) Cargar config desde Supabase
 *  ========================= */
async function loadClientConfig() {
  // 4.1 Cliente (OJO: ahora es clientes_facelens)
  const { data: cData, error: cErr } = await db
    .from("clientes_facelens")
    .select("*")
    .eq("slug", slug)
    .limit(1);

  if (cErr) throw new Error("Error leyendo clientes: " + cErr.message);
  if (!cData || cData.length === 0)
    throw new Error(`No existe el cliente para slug: ${slug}`);

  cliente = cData[0];

  // Plan del cliente (ALL / A / B)
  const plan = (cliente.plan || "ALL").toUpperCase().trim();

  // 4.2 Plataformas
  const { data: pData, error: pErr } = await db
    .from("plataformas")
    .select("*")
    .eq("cliente_id", cliente.id)
    .limit(1);

  if (pErr) throw new Error("Error leyendo plataformas: " + pErr.message);
  plataformas = (pData && pData[0]) || { web:false, whatsapp:false, redes:false };

  // 4.3 Links
  const { data: lData, error: lErr } = await db
    .from("links")
    .select("*")
    .eq("cliente_id", cliente.id)
    .limit(1);

  if (lErr) throw new Error("Error leyendo links: " + lErr.message);
  links = (lData && lData[0]) || {};

  // 4.4 Lentes activos (FILTRADOS POR PLAN)
  let q = db
    .from("lentes")
    .select("*")
    .eq("cliente_id", cliente.id)
    .eq("activo", true);

  // Reglas:
  // - Plan ALL => ve A + B
  // - Plan A   => ve solo A
  // - Plan B   => ve solo B
  if (plan === "A") {
    q = q.eq("grupo", "A");
  } else if (plan === "B") {
    q = q.eq("grupo", "B");
  } else {
    q = q.in("grupo", ["A", "B"]);
  }

  const { data: gData, error: gErr } = await q;
  if (gErr) throw new Error("Error leyendo lentes: " + gErr.message);

  lentes = gData || [];
  if (lentes.length === 0) {
    lentes = [{ nombre_modelo: "Sin lentes cargados", imagen_url: "" }];
  }

  console.log("PLAN ACTUAL:", plan);
  console.log("LENTES CARGADOS:", lentes.length);
}
/* =========================
   5) Lentes
========================= */
function loadCurrentLens() {
  if (!lentes || lentes.length === 0) return;

  const lens = lentes[currentIndex];
  modelNameEl.textContent = lens.nombre_modelo || "Modelo";

  if (!lens.imagen_url) {
    lensImgReady = false;
    return;
  }

  lensImgReady = false;
  lensImg = new Image();
  lensImg.crossOrigin = "anonymous";
  lensImg.src = lens.imagen_url;

  lensImg.onload = () => {
    lensImgReady = true;
  };

  lensImg.onerror = () => {
    lensImgReady = false;
    console.error("Error cargando imagen del lente:", lens.imagen_url);
  };
}
/* =========================
   6) NavegaciÃ³n + filtros
========================= */

let lentesFiltrados = [];

const categoryFilter = document.getElementById("categoryFilter");

// Inicializa filtros
function aplicarFiltro() {
  // âœ… fallback si el select no existe
  const categoria = categoryFilter ? (categoryFilter.value || "all") : "all";

  if (categoria === "all") {
    lentesFiltrados = [...lentes];
  } else {
    lentesFiltrados = lentes.filter(l =>
      (l.categoria || "").toLowerCase().trim() === categoria
    );
  }

  currentIndex = 0;

  if (lentesFiltrados.length === 0) {
    modelNameEl.textContent = "Sin lentes en esta categorÃ­a";
    lensImgReady = false;
    productBtn.classList.add("hidden");
    return;
  }

  loadCurrentLens();
}

// âœ… loadCurrentLens trabaja sobre lentesFiltrados
function loadCurrentLens() {
  if (!lentesFiltrados.length) return;

  const lens = lentesFiltrados[currentIndex];
  modelNameEl.textContent = lens.nombre_modelo || "Modelo";

  lensImgReady = false;

  if (!lens.imagen_url) {
    productBtn.classList.add("hidden");
    return;
  }

  lensImg = new Image();
  lensImg.crossOrigin = "anonymous";
  lensImg.src = lens.imagen_url;

  lensImg.onload = () => (lensImgReady = true);
  lensImg.onerror = () => {
    lensImgReady = false;
    console.warn("No se pudo cargar imagen:", lens.imagen_url);
  };

  if (lens.product_url) {
    productBtn.classList.remove("hidden");
    productBtn.onclick = () => window.open(lens.product_url, "_blank");
  } else {
    productBtn.classList.add("hidden");
  }
}

// Botones
prevBtn.onclick = () => {
  if (!lentesFiltrados.length) return;
  currentIndex = (currentIndex - 1 + lentesFiltrados.length) % lentesFiltrados.length;
  loadCurrentLens();
};

nextBtn.onclick = () => {
  if (!lentesFiltrados.length) return;
  currentIndex = (currentIndex + 1) % lentesFiltrados.length;
  loadCurrentLens();
};

// Captura
captureBtn.onclick = () => {
  const a = document.createElement("a");
  a.download = "facelens.png";
  a.href = canvas.toDataURL("image/png");
  a.click();
};

// Cambio de categorÃ­a
if (categoryFilter) {
  categoryFilter.onchange = aplicarFiltro;
}

/* =========================
   7) AR (FaceMesh â€“ ajuste fino realista)
========================= */
function startAR() {
  const faceMesh = new FaceMesh({
    locateFile: (file) =>
      `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`,
  });

  faceMesh.setOptions({
    maxNumFaces: 1,
    refineLandmarks: true,
    minDetectionConfidence: 0.6,
    minTrackingConfidence: 0.6,
    selfieMode: true,
  });

  // Suavizado
  let smoothX = null;
  let smoothY = null;
  let smoothA = null;

  const lerp = (a, b, t) => a + (b - a) * t;
  const normAngle = (a) => Math.atan2(Math.sin(a), Math.cos(a));

  faceMesh.onResults((results) => {
    if (!video.videoWidth || !video.videoHeight) return;

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

    const faces = results.multiFaceLandmarks;
    if (!faces || faces.length === 0) return;
    if (!lensImgReady || !lensImg || lensImg.naturalWidth === 0) return;

    const lm = faces[0];

    // Landmarks clave
    const L = lm[33];   // ojo izquierdo externo
    const R = lm[263];  // ojo derecho externo
    const N = lm[168];  // puente de la nariz (CLAVE)

    const lx = L.x * canvas.width;
    const ly = L.y * canvas.height;
    const rx = R.x * canvas.width;
    const ry = R.y * canvas.height;
    const nx = N.x * canvas.width;
    const ny = N.y * canvas.height;

    const dx = rx - lx;
    const dy = ry - ly;
    const eyeDist = Math.hypot(dx, dy);

    // RotaciÃ³n real
    const angle = Math.atan2(dy, dx);

    // ðŸ‘‰ Centro REAL del lente (nariz + ajuste)
    const targetX = nx;
    const targetY = ny + eyeDist * 0.06; // ðŸ”§ baja lentes al lugar correcto

    // Suavizado
    if (smoothX === null) {
      smoothX = targetX;
      smoothY = targetY;
      smoothA = angle;
    } else {
      smoothX = lerp(smoothX, targetX, 0.3);
      smoothY = lerp(smoothY, targetY, 0.3);

      const da = normAngle(angle - smoothA);
      smoothA = normAngle(smoothA + da * 0.3);
    }

    // TamaÃ±o del lente (mÃ¡s real)
    const targetW = eyeDist * 1.75; // ðŸ”§ MÃS GRANDE
    const aspect = lensImg.naturalHeight / lensImg.naturalWidth;
    const targetH = targetW * aspect;

    ctx.save();
    ctx.translate(smoothX, smoothY);
    ctx.rotate(smoothA);
    ctx.drawImage(
      lensImg,
      -targetW / 2,
      -targetH / 2,
      targetW,
      targetH
    );
    ctx.restore();
  });

  const camera = new Camera(video, {
    onFrame: async () => {
      await faceMesh.send({ image: video });
    },
    width: 1280,
    height: 720,
  });

  camera.start();
}
/* =========================
   8) Init
========================= */
(async function init(){
  try {
    await loadClientConfig();

    // ðŸ”¹ Inicializar filtros (carga lentesFiltrados)
    aplicarFiltro();

    // ðŸ”¹ Arrancar AR
    startAR();

  } catch(e) {
    console.error(e);
    alert(e.message);
  }
})();
