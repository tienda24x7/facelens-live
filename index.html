<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FaceLens Live</title>

  <!-- MediaPipe -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <!-- Supabase CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { margin:0; background:#0f0f0f; color:#fff; font-family:Arial }
    #container { position:relative; width:100vw; height:100vh }
    video, canvas { position:absolute; width:100%; height:100%; object-fit:cover }
    #ui { position:fixed; bottom:0; left:0; right:0; padding:12px; background:rgba(0,0,0,.60) }
    button, select { padding:10px 12px; border:none; border-radius:10px; font-weight:bold; cursor:pointer }
    button.secondary, select { background:#333; color:#fff }
    button.hidden { display:none }
    #modelName { flex:1; text-align:center; font-weight:bold; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
  </style>
</head>

<body>
  <div id="container">
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas"></canvas>
  </div>

  <div id="ui">
    <!-- Filtro -->
    <select id="categoryFilter" style="width:100%;">
      <option value="all">Todos</option>
      <option value="clasicos">Cl√°sicos</option>
      <option value="degrade">Degrad√©</option>
      <option value="espejados">Espejados</option>
      <option value="polarizados">Polarizados</option>
      <option value="ferrari">Ferrari</option>
    </select>

    <!-- Navegaci√≥n -->
    <div style="display:flex; gap:10px; margin-top:10px; align-items:center;">
      <button id="prevBtn" class="secondary" style="min-width:44px;">‚óÄ</button>
      <span id="modelName">Cargando‚Ä¶</span>
      <button id="nextBtn" class="secondary" style="min-width:44px;">‚ñ∂</button>
    </div>

    <!-- Acciones -->
    <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
      <button id="captureBtn" class="secondary">üì∏ Captura</button>
      <button id="productBtn" class="hidden">üõí Ver producto</button>
    </div>
  </div>

  <script>
  /* =========================
     0) SUPABASE
  ========================= */
const SUPABASE_URL = "https://romgbrobvperljaviekj.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJvbWdicm9idnBlcmxqYXZpZWtqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3MTQ1MTMsImV4cCI6MjA4MjI5MDUxM30.WIpN_Hj0C70bD3Q-Bnxk4tfdgJRr8NnQwmJdM3C5HuI";
const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* =========================
   1) SLUG
========================= */
const slug =
  new URLSearchParams(location.search).get("slug") ||
  (location.pathname || "/").replace(/^\/+|\/+$/g, "") ||
  "tienda24x7_demo";

/* =========================
   2) UI
========================= */
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const modelNameEl = document.getElementById("modelName");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const captureBtn = document.getElementById("captureBtn");
const productBtn = document.getElementById("productBtn");
const categoryFilter = document.getElementById("categoryFilter");

/* =========================
   3) ESTADO
========================= */
let cliente = null;
let lentes = [];
let lentesFiltrados = [];
let currentIndex = 0;

let lensImg = null;
let lensImgReady = false;

/* =========================
   4) CARGA CONFIG (cliente + lentes por plan)
========================= */

// Helpers para cliente (se usan en bloque 4/6)
function normalizePhone(phone) {
  return String(phone || "").replace(/[^\d]/g, "");
}

// Regla simple:
// - Si el cliente pone pa√≠s (ej: 549..., 54..., 598..., 1..., etc) => lo respeta
// - Si pone un n√∫mero "local" (corto) => asumimos Argentina y le anteponemos 549
function normalizeWhatsApp(phone) {
  const p = normalizePhone(phone);
  if (!p) return "";
  if (p.startsWith("54") || p.length >= 12) return p;
  return `549${p}`;
}

function pickFirstClientUrl(cliente) {
  const c = cliente || {};
  const candidates = [
    c.product_url,
    c.productUrl,
    c.ml_url,
    c.mercadolibre_url,
    c.web_url,
    c.tienda_url,
    c.url,
    c.link,
  ];
  for (const u of candidates) {
    if (typeof u === "string" && u.trim()) return u.trim();
  }
  return "";
}

// Helper: obtiene ids de lente desde la tabla lentes_catalogos (soporta distintos nombres)
function pickLensId(row) {
  return (
    row?.lente_id ||
    row?.lens_id ||
    row?.id_lente ||
    row?.lente ||
    row?.lens ||
    null
  );
}

async function loadClientConfig() {
  // =========================
  // 1) Cliente por slug
  // =========================
  const { data: cData, error: cErr } = await db
    .from("clientes_facelens")
    .select("*")
    .eq("slug", slug)
    .limit(1);

  if (cErr) throw new Error("Error leyendo clientes: " + cErr.message);
  if (!cData || cData.length === 0) throw new Error("No existe el cliente para slug: " + slug);

  cliente = cData[0];

  // Guardar cliente global para que lo use el bot√≥n/whatsapp
  window.__client = cliente || {};
  window.__client.whatsapp_norm = normalizeWhatsApp(window.__client.whatsapp || window.__client.WhatsApp || "");
  window.__client.default_url = pickFirstClientUrl(window.__client);

  // Plan del cliente
  const planRaw = String(cliente.plan || "ALL").trim();
  const plan = planRaw.toUpperCase();

  // Base query de lentes (siempre del cliente y activos)
  const baseQ = () =>
    db
      .from("lentes")
      .select("*")
      .eq("cliente_id", cliente.id)
      .eq("activo", true);

  // =========================
  // 2) Traer lentes seg√∫n plan
  // =========================
  let gData = [];
  let mode = "ALL";

  if (plan === "A" || plan === "B") {
    // Legacy por grupo
    mode = `GRUPO_${plan}`;
    const { data, error } = await baseQ().eq("grupo", plan);
    if (error) throw new Error("Error leyendo lentes: " + error.message);
    gData = data || [];

  } else if (plan === "ALL") {
    // ALL = todos los lentes del cliente (sin depender de grupo)
    mode = "ALL";
    const { data, error } = await baseQ();
    if (error) throw new Error("Error leyendo lentes: " + error.message);
    gData = data || [];

  } else {
    // Modo cat√°logo: el plan puede ser "NICOLAS" o "EZEQUIEL"
    // o varios separados por coma: "NICOLAS,EZEQUIEL"
    const catalogos = plan
      .split(",")
      .map(s => s.trim())
      .filter(Boolean);

    mode = `CATALOGOS_${catalogos.join("_")}`;

    // 1) buscar asignaciones en lentes_catalogos por catalogo
    const { data: mapData, error: mapErr } = await db
      .from("lentes_catalogos")
      .select("*")
      .in("catalogo", catalogos);

    if (mapErr) throw new Error("Error leyendo lentes_catalogos: " + mapErr.message);

    const lensIds = (mapData || [])
      .map(pickLensId)
      .filter(Boolean);

    // 2) traer lentes por ids + cliente_id
    if (lensIds.length) {
      const { data, error } = await baseQ().in("id", lensIds);
      if (error) throw new Error("Error leyendo lentes por cat√°logo: " + error.message);
      gData = data || [];
    } else {
      gData = [];
    }

    // Guardamos para debug
    window.__client.catalogos = catalogos;
  }

  lentes = gData || [];

  if (!lentes.length) {
    modelNameEl.textContent = "Sin lentes cargados";
  }

  console.log("CLIENTE GLOBAL ‚úÖ", window.__client);
  console.log("SLUG:", slug, "PLAN:", plan, "MODO:", mode, "LENTES:", lentes.length);

  return { cliente, plan, lentes, mode };
}

/* =========================
   5) FILTRO
========================= */

/**
 * WRAP seguro: cuando se ejecute loadClientConfig(), guardamos
 * el cliente en window.__client para que el bot√≥n WhatsApp funcione.
 * NO rompe nada aunque loadClientConfig no devuelva nada.
 */
(function wrapLoadClientConfig() {
  if (typeof loadClientConfig !== "function") return;
  if (loadClientConfig.__wrapped) return;

  const _orig = loadClientConfig;

  // helper interno
  function setClientGlobal(maybeResult) {
    // buscamos por prioridad: return -> globals existentes -> {}.
    const candidate =
      (maybeResult && (maybeResult.cliente || maybeResult.client || maybeResult.config)) ||
      maybeResult ||
      window.clientConfig ||
      window.cliente ||
      window.config ||
      window.__client ||
      {};

    window.__client = candidate;
    console.log("CLIENTE GLOBAL ‚úÖ", window.__client);
  }

  loadClientConfig = async function (...args) {
    const res = await _orig.apply(this, args);
    try {
      setClientGlobal(res);
    } catch (e) {
      // no cortamos la app por esto
      console.warn("No pude setear window.__client:", e);
    }
    return res;
  };

  loadClientConfig.__wrapped = true;
})();

function aplicarFiltro() {
  const categoria = (categoryFilter?.value || "all").toLowerCase().trim();

  if (categoria === "all") {
    lentesFiltrados = [...lentes];
  } else {
    lentesFiltrados = lentes.filter(l =>
      String(l.categoria || "").toLowerCase().trim() === categoria
    );
  }

  currentIndex = 0;

  if (!lentesFiltrados.length) {
    modelNameEl.textContent = "Sin lentes en esta categor√≠a";
    lensImgReady = false;
    productBtn.classList.add("hidden");
    productBtn.onclick = null;
    return;
  }

  // IMPORTANTE: mostrar el primer lente del filtro sin "saltar"
  loadCurrentLens();
}

categoryFilter.onchange = aplicarFiltro;

/* =========================
   6) LENTES (carga imagen + bot√≥n producto)
========================= */

function buildWhatsAppUrl(phone, lens) {
  const p = normalizePhone(phone);
  if (!p) return "";

  const model = String(lens?.nombre_modelo || lens?.nombre || "").trim();
  const msg = model
    ? `Hola! Quiero consultar por el modelo: ${model}`
    : `Hola! Quiero consultar por un modelo de lentes.`;

  return `https://wa.me/${p}?text=${encodeURIComponent(msg)}`;
}

function pickFirstUrl(lens) {
  const candidates = [
    lens?.product_url,
    lens?.productUrl,
    lens?.ml_url,
    lens?.mercadolibre_url,
    lens?.web_url,
    lens?.tienda_url,
    lens?.url,
  ];
  for (const u of candidates) {
    if (typeof u === "string" && u.trim()) return u.trim();
  }
  return "";
}

function getClientWhatsApp() {
  const c = window.__client || {};
  // usamos el normalizado que seteamos en el bloque 4
  const wa = c.whatsapp_norm || c.whatsapp || c.WhatsApp || "";
  return String(wa || "").trim();
}

function getClientDefaultUrl() {
  const c = window.__client || {};
  return (
    (typeof c.default_url === "string" && c.default_url.trim()) ? c.default_url.trim()
    : pickFirstClientUrl(c)
  );
}

function loadCurrentLens() {
  if (!lentesFiltrados || !lentesFiltrados.length) return;

  // ‚úÖ FIX CLAVE: NO tocar currentIndex ac√°
  const safeIndex = ((currentIndex % lentesFiltrados.length) + lentesFiltrados.length) % lentesFiltrados.length;
  const lens = lentesFiltrados[safeIndex];

  modelNameEl.textContent = lens?.nombre_modelo || lens?.nombre || "Modelo";

  // =========================
  // Bot√≥n "Ver producto" (Prioridad: Lente > Cliente > WhatsApp)
  // =========================
  const urlLens = pickFirstUrl(lens);
  const urlCliente = getClientDefaultUrl();
  const waPhone = getClientWhatsApp();
  const waUrl = buildWhatsAppUrl(waPhone, lens);

  const finalUrl = urlLens || urlCliente || waUrl;

  console.log("BTN DEBUG:", {
    urlLens,
    urlCliente,
    waPhone,
    finalUrl,
    idx: safeIndex,
    total: lentesFiltrados.length
  });

  if (finalUrl) {
    productBtn.classList.remove("hidden");
    productBtn.style.display = "inline-flex";     // fuerza visible en el layout
    productBtn.style.alignItems = "center";
    productBtn.style.justifyContent = "center";

    // ‚úÖ Siempre el mismo texto
    productBtn.textContent = "üõí Ver producto";
    productBtn.onclick = () => window.open(finalUrl, "_blank", "noopener");
  } else {
    productBtn.classList.add("hidden");
    productBtn.onclick = null;
  }

  // =========================
  // Imagen
  // =========================
  lensImgReady = false;
  const imgUrl = lens?.imagen_url || "";
  if (!imgUrl) return;

  lensImg = new Image();
  lensImg.crossOrigin = "anonymous";
  lensImg.src = imgUrl;

  lensImg.onload = () => { lensImgReady = true; };
  lensImg.onerror = () => { lensImgReady = false; console.warn("No carg√≥ imagen:", imgUrl); };
}

/* Navegaci√≥n */
prevBtn.onclick = () => {
  if (!lentesFiltrados || !lentesFiltrados.length) return;
  currentIndex = (currentIndex - 1 + lentesFiltrados.length) % lentesFiltrados.length;
  loadCurrentLens();
};

nextBtn.onclick = () => {
  if (!lentesFiltrados || !lentesFiltrados.length) return;
  currentIndex = (currentIndex + 1) % lentesFiltrados.length;
  loadCurrentLens();
};

/* =========================
   7) AR (FaceMesh + suavizado + tama√±o estable)
========================= */
function startAR() {
  const faceMesh = new FaceMesh({
    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`,
  });

  faceMesh.setOptions({
    maxNumFaces: 1,
    refineLandmarks: true,
    minDetectionConfidence: 0.6,
    minTrackingConfidence: 0.6,
    selfieMode: true,
  });

  let smoothX = null, smoothY = null, smoothA = null, smoothD = null;
  const lerp = (a,b,t)=>a+(b-a)*t;
  const normAngle = (a)=>Math.atan2(Math.sin(a), Math.cos(a));

  faceMesh.onResults((results) => {
    if (!video.videoWidth || !video.videoHeight) return;

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(results.image, 0,0,canvas.width,canvas.height);

    const faces = results.multiFaceLandmarks;
    if (!faces || !faces.length) return;
    if (!lensImgReady || !lensImg || lensImg.naturalWidth === 0) return;

    const lm = faces[0];

    const L = lm[33];
    const R = lm[263];
    const N = lm[168];

    const lx = L.x * canvas.width;
    const ly = L.y * canvas.height;
    const rx = R.x * canvas.width;
    const ry = R.y * canvas.height;
    const nx = N.x * canvas.width;
    const ny = N.y * canvas.height;

    const dx = rx - lx;
    const dy = ry - ly;
    const eyeDist = Math.hypot(dx, dy);

    const angle = Math.atan2(dy, dx);

    const targetX = nx;
    const targetY = ny + eyeDist * 0.06;

    // suavizado m√°s fuerte (menos temblor)
    const T = 0.18;

    if (smoothX === null) {
      smoothX = targetX; smoothY = targetY; smoothA = angle; smoothD = eyeDist;
    } else {
      smoothX = lerp(smoothX, targetX, T);
      smoothY = lerp(smoothY, targetY, T);
      smoothD = lerp(smoothD, eyeDist, T);

      const da = normAngle(angle - smoothA);
      smoothA = normAngle(smoothA + da * T);
    }

    // tama√±o estable usando eyeDist suavizado
    const targetW = Math.min (smoothD * 1.85, 320);
    const aspect = lensImg.naturalHeight / lensImg.naturalWidth;
    const targetH = targetW * aspect;

    ctx.save();
    ctx.translate(smoothX, smoothY);
    ctx.rotate(smoothA);
    ctx.drawImage(lensImg, -targetW/2, -targetH/2, targetW, targetH);
    ctx.restore();
  });

  const camera = new Camera(video, {
    onFrame: async () => { await faceMesh.send({ image: video }); },
    width: 1280,
    height: 720,
  });

  camera.start();
}
/* =========================
     INIT
  ========================= */
  (async function () {
    try {
      console.log("INIT ‚úÖ arranc√≥");

      if (typeof loadClientConfig !== "function") {
        throw new Error("loadClientConfig() no est√° definida");
      }

      if (typeof startAR !== "function") {
        throw new Error("startAR() no est√° definida");
      }

      await loadClientConfig();
      console.log("loadClientConfig ‚úÖ OK");

      if (typeof aplicarFiltro === "function") {
        aplicarFiltro();
        console.log("aplicarFiltro ‚úÖ OK");
      } else if (typeof loadCurrentLens === "function") {
        loadCurrentLens();
        console.log("loadCurrentLens (sin filtro) ‚úÖ OK");
      }

      startAR();
      console.log("startAR ‚úÖ OK");

    } catch (e) {
      console.error("INIT ‚ùå", e);
      alert(e.message || String(e));
    }
  })();
</script>

</body>
</html>