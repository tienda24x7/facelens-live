<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FaceLens Live</title>

  <!-- ‚úÖ Android browser UI color (se actualizar√° por JS si hay branding) -->
  <meta name="theme-color" content="#0f0f0f" />

  <!-- MediaPipe -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <!-- Supabase CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
  /* =========================
     ‚úÖ BRAND DEFAULT (no rompe nada)
  ========================= */
  :root{
    --brand-primary: #0f0f0f;         /* fondo base */
    --brand-surface: rgba(0,0,0,.60); /* panel UI */
    --brand-accent: #ffffff;          /* acento (texto/botones) */
    --brand-muted: #333333;           /* secundarios */
    --brand-on-primary: #ffffff;      /* texto sobre primary/surface */
  }

  body { margin:0; background:var(--brand-primary); color:var(--brand-on-primary); font-family:Arial }

  #container { position:relative; width:100vw; height:100vh }
  video, canvas { position:absolute; width:100%; height:100%; object-fit:cover }

  /* ‚úÖ Logo arriba (overlay seguro) */
  #brandBar{
    position:fixed;
    top:0; left:0; right:0;
    display:flex;
    align-items:center;
    gap:10px;
    padding:10px 12px;
    pointer-events:none; /* no bloquea clicks */
    z-index:10;
  }

  /* ‚úÖ Solo cuando hay logo cargado (clase la agrega JS) */
  #brandBar.hasBrand{
    background: linear-gradient(to bottom, rgba(0,0,0,.35), rgba(0,0,0,0));
  }

  /* ‚úÖ Logo +30% (m√≥vil y PC) */
  #brandLogo{
    height:42px;          /* antes 32px */
    display:none;         /* se muestra cuando carga */
    pointer-events:none;
    filter: drop-shadow(0 2px 6px rgba(0,0,0,.55));
  }

  /* ‚úÖ Desktop: +30% respecto al anterior desktop (38px -> ~49px) */
  @media (min-width: 900px){
    #brandLogo{ height:50px; }
  }

  #brandTitle{
    font-weight:bold;
    opacity:.92;
    text-shadow: 0 2px 6px rgba(0,0,0,.55);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    max-width:70vw;
    display:none; /* opcional: se activa si hay nombre de marca */
  }

  /* ‚úÖ Panel inferior con "marca" visible en PC */
  #ui {
    position:fixed;
    bottom:0; left:0; right:0;
    padding:12px;
    background:var(--brand-surface);
    z-index:9;

    /* ‚úÖ Esto hace que el primario se vea tambi√©n en desktop */
    border-top: 4px solid var(--brand-primary);
  }

  button, select { padding:10px 12px; border:none; border-radius:10px; font-weight:bold; cursor:pointer }

  /* ‚úÖ Bot√≥n primario (si alg√∫n d√≠a lo us√°s) */
  button.primary { background:var(--brand-accent); color:#000; }

  /* ‚úÖ Secundarios (como ya ven√≠as usando) */
  button.secondary, select { background:var(--brand-muted); color:var(--brand-on-primary) }

  button.hidden { display:none }

  #modelName { flex:1; text-align:center; font-weight:bold; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }

  /* =========================
     ‚úÖ ONBOARDING OVERLAY (1ra vez)
  ========================= */
  #onboardOverlay{
    position:fixed;
    inset:0;
    z-index:9999;
    display:none;                 /* se activa por JS */
    align-items:center;
    justify-content:center;
    padding:18px;
    background:rgba(0,0,0,.72);
  }

  #onboardCard{
    width:min(520px, 92vw);
    border-radius:16px;
    padding:16px 16px 14px;
    background:rgba(20,20,20,.92);
    box-shadow:0 10px 40px rgba(0,0,0,.5);
    border:1px solid rgba(255,255,255,.08);
  }

  #onboardTitle{
    font-size:16px;
    font-weight:800;
    margin:0 0 8px 0;
  }

  #onboardList{
    margin:0;
    padding-left:18px;
    line-height:1.35;
    opacity:.95;
    font-size:14px;
  }

  #onboardHint{
    margin-top:10px;
    font-size:13px;
    opacity:.85;
  }

  #onboardActions{
    margin-top:12px;
    display:flex;
    gap:10px;
    justify-content:flex-end;
    align-items:center;
  }

  #onboardBtn{
    pointer-events:auto;
    padding:10px 12px;
    border:none;
    border-radius:12px;
    font-weight:800;
    cursor:pointer;

    /* usa branding si existe */
    background:var(--brand-accent);
    color:#000;
  }

  #onboardLater{
    pointer-events:auto;
    background:transparent;
    border:none;
    color:var(--brand-on-primary);
    opacity:.85;
    cursor:pointer;
    font-weight:700;
  }
  #onboardLater:hover{ opacity:1; }

  /* =========================
     ‚úÖ SEARCH OVERLAY (BUSCADOR)  [PASO 2]
  ========================= */
  #searchOverlay{
    position:fixed;
    inset:0;
    z-index:9998; /* debajo del onboarding (9999) */
    display:none;
    align-items:center;
    justify-content:center;
    padding:14px;
    background:rgba(0,0,0,.72);
  }

  #searchCard{
    width:min(620px, 94vw);
    max-height:min(78vh, 620px);
    overflow:hidden;
    border-radius:16px;
    padding:12px;
    background:rgba(20,20,20,.95);
    box-shadow:0 10px 40px rgba(0,0,0,.55);
    border:1px solid rgba(255,255,255,.10);
  }

  #searchHeader{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-bottom:10px;
  }

  #searchTitle{
    font-weight:900;
    font-size:15px;
    opacity:.95;
  }

  #searchInput{
    width:100%;
    padding:12px 12px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.12);
    outline:none;
    background:rgba(0,0,0,.35);
    color:var(--brand-on-primary);
    font-weight:700;
  }

  #searchInput::placeholder{ opacity:.65; }

  #searchHint{
    margin-top:8px;
    font-size:12px;
    opacity:.75;
  }

  #searchResults{
    margin-top:10px;
    overflow:auto;
    max-height:52vh;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.08);
    background:rgba(0,0,0,.20);
  }

  .searchItem{
    display:flex;
    gap:10px;
    align-items:flex-start;
    padding:10px 12px;
    cursor:pointer;
    border-bottom:1px solid rgba(255,255,255,.06);
  }
  .searchItem:hover{ background:rgba(255,255,255,.06); }
  .searchItem:last-child{ border-bottom:none; }

  .searchName{
    font-weight:900;
    font-size:13px;
    line-height:1.2;
  }

  .searchMeta{
    margin-top:2px;
    font-size:12px;
    opacity:.78;
  }

  .searchEmpty{
    padding:14px 12px;
    opacity:.78;
    font-size:13px;
  }
</style>
</head>

<body>
  <!-- ‚úÖ BRAND BAR -->
  <div id="brandBar">
    <img id="brandLogo" alt="Logo" />
    <div id="brandTitle"></div>
  </div>

  <div id="container">
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas"></canvas>
  </div>

  <!-- ‚úÖ ONBOARDING OVERLAY -->
  <div id="onboardOverlay">
    <div id="onboardCard">
      <div id="onboardTitle">Probador virtual FaceLens</div>
      <ol id="onboardList">
        <li>Permit√≠ la c√°mara cuando te lo pida el navegador.</li>
        <li>Ubic√° tu cara centrada y con buena luz.</li>
        <li><b>Distancia sugerida:</b> 30‚Äì45 cm del dispositivo (a la altura de los ojos).</li>
        <li>Us√° ‚óÄ ‚ñ∂ para cambiar modelos y ‚Äúüõí Ver producto‚Äù para consultar.</li>
      </ol>

      <div id="onboardHint">Tip: si el lente ‚Äúbaila‚Äù, mejor√° la luz o mir√° de frente a la c√°mara.</div>

      <div id="onboardActions">
        <button id="onboardLater" type="button">No mostrar m√°s</button>
        <button id="onboardBtn" type="button">Entendido</button>
      </div>
    </div>
  </div>

  <div id="ui">
  <!-- Filtro -->
  <select id="categoryFilter" style="width:100%;">
    <option value="all">Todos</option>
    <option value="clasicos">Cl√°sicos</option>
    <option value="degrade">Degrad√©</option>
    <option value="espejados">Espejados</option>
    <option value="polarizados">Polarizados</option>
    <option value="ferrari">Ferrari</option>
  </select>

  <!-- Navegaci√≥n -->
  <div style="display:flex; gap:10px; margin-top:10px; align-items:center;">
    <button id="prevBtn" class="secondary" style="min-width:44px;">‚óÄ</button>

    <span id="modelName" style="flex:1; text-align:center; font-weight:bold; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
      Cargando‚Ä¶
    </span>

    <!-- ‚úÖ Lupa b√∫squeda -->
    <button id="searchBtn" class="secondary" style="min-width:44px;" title="Buscar modelo">üîé</button>

    <button id="nextBtn" class="secondary" style="min-width:44px;">‚ñ∂</button>
  </div>

  <!-- Acciones -->
  <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
    <button id="captureBtn" class="secondary">üì∏ Captura</button>
    <button id="productBtn" class="hidden">üõí Ver producto</button>
  </div>
</div>

<!-- =========================
     ‚úÖ SEARCH OVERLAY (BUSCADOR)
========================= -->
<div id="searchOverlay" aria-hidden="true">
  <div id="searchCard">
    <div id="searchHeader">
      <div id="searchTitle">Buscar modelo</div>
      <button id="searchClose" type="button" class="secondary" style="min-width:44px;">‚úï</button>
    </div>

    <input id="searchInput" type="text" placeholder="Escrib√≠ modelo, color o SKU‚Ä¶"
           autocomplete="off" />

    <div id="searchHint">Tip: pod√©s buscar por ‚ÄúRayban‚Äù, ‚Äúdegrad√©‚Äù, o el n√∫mero de SKU.</div>

    <div id="searchResults"></div>
  </div>
</div>

  <script>
/* =========================
   ‚úÖ ONBOARDING OVERLAY (1ra vez por dispositivo)
========================= */
(function setupOnboardingOverlay(){
  const KEY = "facelens_onboard_done_v1";

  const overlay = document.getElementById("onboardOverlay");
  const btnOk = document.getElementById("onboardBtn");
  const btnNever = document.getElementById("onboardLater");

  if (!overlay || !btnOk || !btnNever) return;

  function hide() { overlay.style.display = "none"; }
  function show() { overlay.style.display = "flex"; }

  // Si ya lo vio antes, no mostramos
  const done = localStorage.getItem(KEY);
  if (!done) show();

  btnOk.onclick = () => { hide(); };

  btnNever.onclick = () => {
    localStorage.setItem(KEY, "1");
    hide();
  };

  // Cerrar si toca afuera
  overlay.addEventListener("click", (e) => {
    if (e.target === overlay) hide();
  });
})();

/* =========================
     0) SUPABASE
  ========================= */
const SUPABASE_URL = "https://romgbrobvperljaviekj.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJvbWdicm9idnBlcmxqYXZpZWtqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3MTQ1MTMsImV4cCI6MjA4MjI5MDUxM30.WIpN_Hj0C70bD3Q-Bnxk4tfdgJRr8NnQwmJdM3C5HuI";
const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* =========================
   1) SLUG
========================= */
const slug =
  new URLSearchParams(location.search).get("slug") ||
  (location.pathname || "/").replace(/^\/+|\/+$/g, "") ||
  "tienda24x7_demo";

/* =========================
   2) UI
========================= */
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const modelNameEl = document.getElementById("modelName");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const captureBtn = document.getElementById("captureBtn");
const productBtn = document.getElementById("productBtn");
const categoryFilter = document.getElementById("categoryFilter");

/* =========================
   2.2) UI - BUSCADOR (LUPA)
========================= */
const searchBtn = document.getElementById("searchBtn");
const searchOverlay = document.getElementById("searchOverlay");
const searchClose = document.getElementById("searchClose");
const searchInput = document.getElementById("searchInput");
const searchResults = document.getElementById("searchResults");
/* =========================
   3) ESTADO
========================= */
let cliente = null;
let lentes = [];
let lentesFiltrados = [];
let currentIndex = 0;

let lensImg = null;
let lensImgReady = false;

/* =========================
   4) CARGA CONFIG (cliente + lentes por plan)
========================= */

// Helpers para cliente (se usan en bloque 4/6)
function normalizePhone(phone) {
  return String(phone || "").replace(/[^\d]/g, "");
}

// Regla simple:
// - Si el cliente pone pa√≠s (ej: 549..., 54..., 598..., 1..., etc) => lo respeta
// - Si pone un n√∫mero "local" (corto) => asumimos Argentina y le anteponemos 549
function normalizeWhatsApp(phone) {
  const p = normalizePhone(phone);
  if (!p) return "";
  if (p.startsWith("54") || p.length >= 12) return p;
  return `549${p}`;
}

function pickFirstClientUrl(cliente) {
  const c = cliente || {};
  const candidates = [
    c.product_url,
    c.productUrl,
    c.ml_url,
    c.mercadolibre_url,
    c.web_url,
    c.tienda_url,
    c.url,
    c.link,
  ];
  for (const u of candidates) {
    if (typeof u === "string" && u.trim()) return u.trim();
  }
  return "";
}

// Helper: obtiene ids de lente desde la tabla lentes_catalogos (soporta distintos nombres)
function pickLensId(row) {
  return (
    row?.lente_id ||
    row?.lens_id ||
    row?.id_lente ||
    row?.lente ||
    row?.lens ||
    null
  );
}

/* =========================
   ‚úÖ BRANDING helpers (logo + colores por cliente)
   Usamos SOLO:
   - logo_url
   - color_primario
   - olor_secundario   (typo intencional)
========================= */
function cleanStr(v) {
  return String(v || "").replace(/\r?\n/g, "").trim();
}

function parseHexToRgb(hex) {
  const h = cleanStr(hex).replace("#", "");
  if (![3, 6].includes(h.length)) return null;
  const full = h.length === 3 ? h.split("").map(ch => ch + ch).join("") : h;
  const n = parseInt(full, 16);
  if (!Number.isFinite(n)) return null;
  return { r: (n >> 16) & 255, g: (n >> 8) & 255, b: n & 255 };
}

function autoTextOn(bgHex) {
  const rgb = parseHexToRgb(bgHex);
  if (!rgb) return "";
  const lum = (0.2126 * rgb.r + 0.7152 * rgb.g + 0.0722 * rgb.b) / 255;
  return lum > 0.62 ? "#000000" : "#ffffff";
}

function tintSurfaceFromPrimary(primaryHex, alpha) {
  const rgb = parseHexToRgb(primaryHex);
  if (!rgb) return "";
  const a = Number.isFinite(alpha) ? alpha : 0.45;
  return `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${a})`;
}

function getBrandFromClient(cliente) {
  const c = cliente || {};
  return {
    name: cleanStr(c.nombre || c.name || ""),
    logoUrl: cleanStr(c.logo_url || c.logo || ""),
    primary: cleanStr(c.color_primario || c.color_principal || ""),
    accent: cleanStr(c.olor_secundario || ""),
  };
}

function applyBrandingFromClient(db, cliente) {
  const brand = getBrandFromClient(cliente);

  const onPrimary = autoTextOn(brand.primary) || "#ffffff";
  const surface = tintSurfaceFromPrimary(brand.primary, 0.45) || "rgba(0,0,0,.60)";
  const muted = "#333333";

  const root = document.documentElement;
  if (brand.primary) root.style.setProperty("--brand-primary", brand.primary);
  root.style.setProperty("--brand-surface", surface);
  if (brand.accent) root.style.setProperty("--brand-accent", brand.accent);
  root.style.setProperty("--brand-muted", muted);
  root.style.setProperty("--brand-on-primary", onPrimary);

  if (brand.primary) {
    let meta = document.querySelector('meta[name="theme-color"]');
    if (!meta) {
      meta = document.createElement("meta");
      meta.setAttribute("name", "theme-color");
      document.head.appendChild(meta);
    }
    meta.setAttribute("content", brand.primary);
  }

  const titleEl = document.getElementById("brandTitle");
  if (titleEl) {
    if (brand.name) {
      titleEl.textContent = brand.name;
      titleEl.style.display = "block";
    } else {
      titleEl.style.display = "none";
    }
  }

  const logoEl = document.getElementById("brandLogo");
  if (logoEl) {
    const logoUrl = brand.logoUrl || "";
    if (logoUrl) {
      const ver = window.__ASSET_VER__ ? `v=${window.__ASSET_VER__}` : `v=${Date.now()}`;
      const src = logoUrl.includes("?") ? `${logoUrl}&${ver}` : `${logoUrl}?${ver}`;

      logoEl.onload = () => {
        logoEl.style.display = "inline-block";
        const bar = document.getElementById("brandBar");
        if (bar) bar.classList.add("hasBrand");
      };
      logoEl.onerror = () => {
        console.warn("Logo no carg√≥:", logoUrl);
        logoEl.style.display = "none";
        const bar = document.getElementById("brandBar");
        if (bar) bar.classList.remove("hasBrand");
      };
      logoEl.src = src;
    } else {
      logoEl.style.display = "none";
      const bar = document.getElementById("brandBar");
      if (bar) bar.classList.remove("hasBrand");
    }
  }

  console.log("BRANDING ‚úÖ aplicado", { ...brand, surface, onPrimary });
}

async function loadClientConfig() {
  const { data: cData, error: cErr } = await db
    .from("clientes_facelens")
    .select("*")
    .eq("slug", slug)
    .limit(1);

  if (cErr) throw new Error("Error leyendo clientes: " + cErr.message);
  if (!cData || cData.length === 0) throw new Error("No existe el cliente para slug: " + slug);

  cliente = cData[0];

  window.__ASSET_VER__ = Date.now();
  try { applyBrandingFromClient(db, cliente); } catch (e) { console.warn("Branding fall√≥:", e); }

  window.__client = cliente || {};
  window.__client.whatsapp_norm = normalizeWhatsApp(window.__client.whatsapp || window.__client.WhatsApp || "");
  window.__client.default_url = pickFirstClientUrl(window.__client);

  const planRaw = String(cliente.plan || "ALL").trim();
  const plan = planRaw.toUpperCase();

  const baseQ = () =>
    db
      .from("lentes")
      .select("*")
      .eq("cliente_id", cliente.id)
      .eq("activo", true);

  let gData = [];
  let mode = "ALL";

  if (plan === "A" || plan === "B") {
    mode = `GRUPO_${plan}`;
    const { data, error } = await baseQ().eq("grupo", plan);
    if (error) throw new Error("Error leyendo lentes: " + error.message);
    gData = data || [];
  } else if (plan === "ALL") {
    mode = "ALL";
    const { data, error } = await baseQ();
    if (error) throw new Error("Error leyendo lentes: " + error.message);
    gData = data || [];
  } else {
    const catalogos = plan
      .split(",")
      .map(s => s.trim())
      .filter(Boolean);

    mode = `CATALOGOS_${catalogos.join("_")}`;

    const { data: mapData, error: mapErr } = await db
      .from("lentes_catalogos")
      .select("*")
      .in("catalogo", catalogos);

    if (mapErr) throw new Error("Error leyendo lentes_catalogos: " + mapErr.message);

    const lensIds = (mapData || [])
      .map(pickLensId)
      .filter(Boolean);

    if (lensIds.length) {
      const { data, error } = await baseQ().in("id", lensIds);
      if (error) throw new Error("Error leyendo lentes por cat√°logo: " + error.message);
      gData = data || [];
    } else {
      gData = [];
    }

    window.__client.catalogos = catalogos;
  }

  lentes = gData || [];

  if (!lentes.length) {
    modelNameEl.textContent = "Sin lentes cargados";
  }

  console.log("CLIENTE GLOBAL ‚úÖ", window.__client);
  console.log("SLUG:", slug, "PLAN:", plan, "MODO:", mode, "LENTES:", lentes.length);

  return { cliente, plan, lentes, mode };
}

/* =========================
   5) FILTRO
========================= */
(function wrapLoadClientConfig() {
  if (typeof loadClientConfig !== "function") return;
  if (loadClientConfig.__wrapped) return;

  const _orig = loadClientConfig;

  function setClientGlobal(maybeResult) {
    const candidate =
      (maybeResult && (maybeResult.cliente || maybeResult.client || maybeResult.config)) ||
      maybeResult ||
      window.clientConfig ||
      window.cliente ||
      window.config ||
      window.__client ||
      {};

    window.__client = candidate;
    console.log("CLIENTE GLOBAL ‚úÖ", window.__client);
  }

  loadClientConfig = async function (...args) {
    const res = await _orig.apply(this, args);
    try {
      setClientGlobal(res);
    } catch (e) {
      console.warn("No pude setear window.__client:", e);
    }
    return res;
  };

  loadClientConfig.__wrapped = true;
})();

function aplicarFiltro() {
  const categoria = (categoryFilter?.value || "all").toLowerCase().trim();

  if (categoria === "all") {
    lentesFiltrados = [...lentes];
  } else {
    lentesFiltrados = lentes.filter(l =>
      String(l.categoria || "").toLowerCase().trim() === categoria
    );
  }

  currentIndex = 0;

  if (!lentesFiltrados.length) {
    modelNameEl.textContent = "Sin lentes en esta categor√≠a";
    lensImgReady = false;
    productBtn.classList.add("hidden");
    productBtn.onclick = null;
    return;
  }

  loadCurrentLens();
}

categoryFilter.onchange = aplicarFiltro;

/* =========================
   5.5) BUSCADOR (LUPA) - usa lentesFiltrados
   ‚ö†Ô∏è IMPORTANTE: NO redeclaramos searchBtn/searchOverlay/etc
   porque ya existen en el BLOQUE 2) UI
========================= */

// Si por alg√∫n motivo no existen los elementos del buscador, no rompemos la app
const __hasSearchUI =
  (typeof searchBtn !== "undefined" && searchBtn) &&
  (typeof searchOverlay !== "undefined" && searchOverlay) &&
  (typeof searchClose !== "undefined" && searchClose) &&
  (typeof searchInput !== "undefined" && searchInput) &&
  (typeof searchResults !== "undefined" && searchResults);

function normTxt(s){
  return String(s || "")
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")   // quita acentos
    .trim();
}

function lensDisplayName(l){
  return String(l?.nombre_modelo || l?.nombre || "Modelo").trim();
}

function lensSku(l){
  return String(l?.sku || l?.SKU || l?.codigo || l?.id_sku || "").trim();
}

function openSearch(){
  if (!__hasSearchUI) return;
  searchOverlay.style.display = "flex";
  searchOverlay.setAttribute("aria-hidden", "false");
  searchInput.value = "";
  setTimeout(() => searchInput.focus(), 50);
  renderSearchResults("");
}

function closeSearch(){
  if (!__hasSearchUI) return;
  searchOverlay.style.display = "none";
  searchOverlay.setAttribute("aria-hidden", "true");
}

function renderSearchResults(q){
  if (!__hasSearchUI) return;

  const query = normTxt(q);

  // base: siempre usamos lo filtrado por categor√≠a (lentesFiltrados)
  const arr = Array.isArray(lentesFiltrados) ? lentesFiltrados : [];
  if (!arr.length){
    searchResults.innerHTML = `<div class="searchEmpty">No hay lentes cargados en esta categor√≠a.</div>`;
    return;
  }

  let matches = [];
  if (!query){
    matches = arr.slice(0, 25).map((l, idx) => ({ l, idx }));
  } else {
    for (let i=0; i<arr.length; i++){
      const l = arr[i];
      const name = normTxt(lensDisplayName(l));
      const sku = normTxt(lensSku(l));
      const cat = normTxt(l?.categoria || "");
      if (name.includes(query) || sku.includes(query) || cat.includes(query)){
        matches.push({ l, idx: i });
        if (matches.length >= 40) break;
      }
    }
  }

  if (!matches.length){
    searchResults.innerHTML = `<div class="searchEmpty">Sin resultados. Prob√° con otra palabra o SKU.</div>`;
    return;
  }

  searchResults.innerHTML = matches.map(({l, idx}) => {
    const name = lensDisplayName(l);
    const sku = lensSku(l);
    const cat = String(l?.categoria || "").trim();
    const meta = [sku && `SKU: ${sku}`, cat && `Cat: ${cat}`].filter(Boolean).join(" ‚Ä¢ ");
    return `
      <div class="searchItem" data-idx="${idx}">
        <div style="flex:1;">
          <div class="searchName">${name}</div>
          <div class="searchMeta">${meta || ""}</div>
        </div>
      </div>
    `;
  }).join("");

  Array.from(searchResults.querySelectorAll(".searchItem")).forEach(el => {
    el.addEventListener("click", () => {
      const idx = Number(el.getAttribute("data-idx"));
      if (!Number.isFinite(idx)) return;
      currentIndex = idx;
      closeSearch();
      loadCurrentLens().catch(err => console.warn("loadCurrentLens search error:", err));
    });
  });
}

// wiring botones
if (__hasSearchUI) {
  searchBtn.addEventListener("click", openSearch);
  searchClose.addEventListener("click", closeSearch);

  // cerrar tocando afuera
  searchOverlay.addEventListener("click", (e) => {
    if (e.target === searchOverlay) closeSearch();
  });

  // input handler (con mini debounce)
  let __searchT = null;
  searchInput.addEventListener("input", () => {
    clearTimeout(__searchT);
    __searchT = setTimeout(() => renderSearchResults(searchInput.value), 120);
  });

  searchInput.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeSearch();
  });
}

// ‚úÖ Cuando cambia el filtro, si el buscador est√° abierto, refrescamos resultados
const _origAplicarFiltro = aplicarFiltro;
aplicarFiltro = function(){
  _origAplicarFiltro();
  if (__hasSearchUI && searchOverlay.style.display === "flex") {
    renderSearchResults(searchInput.value || "");
  }
};
/* =========================
   6) LENTES (carga imagen + bot√≥n producto)
========================= */

// Asegurar referencia al bot√≥n sin romper nada
const productBtnSafe = (typeof productBtn !== "undefined" && productBtn)
  ? productBtn
  : document.getElementById("productBtn");

function buildWhatsAppUrl(phone, lens) {
  const p = normalizePhone(phone);
  if (!p) return "";

  const model = String(lens?.nombre_modelo || lens?.nombre || "").trim();
  const msg = model
    ? `Hola! Quiero consultar por el modelo: ${model}`
    : `Hola! Quiero consultar por un modelo de lentes.`;

  return `https://wa.me/${p}?text=${encodeURIComponent(msg)}`;
}

function pickFirstUrlFromCandidates(candidates) {
  for (const u of candidates) {
    if (typeof u === "string" && u.trim()) return u.trim();
  }
  return "";
}

function pickFirstUrl(lens) {
  return pickFirstUrlFromCandidates([
    lens?.product_url,
    lens?.productUrl,
    lens?.ml_url,
    lens?.mercadolibre_url,
    lens?.web_url,
    lens?.tienda_url,
    lens?.url,
  ]);
}

function getClientWhatsApp() {
  const c = window.__client || {};
  const wa = c.whatsapp_norm || c.whatsapp || c.WhatsApp || "";
  return String(wa || "").trim();
}

function getClientDefaultUrl() {
  const c = window.__client || {};
  return pickFirstUrlFromCandidates([
    c.default_url,
    c.defaultUrl,
    c.cliente_url,
    c.product_url,
    c.productUrl,
    c.ml_url,
    c.mercadolibre_url,
    c.web_url,
    c.tienda_url,
    c.url,
    c.link,
  ]);
}

/* =========================
   ‚úÖ helpers para URLs Storage por SKU
========================= */

// Base Supabase
const SUPABASE_PROJECT_URL = "https://romgbrobvperljaviekj.supabase.co";
const STORAGE_BUCKET = "facelens-assets";

// Folder principal por cliente (slug)
function getLensFolderForClient() {
  const c = window.__client || {};

  const s1 = String(c.slug || "").trim();
  if (s1) return s1;

  const s2 = (typeof slug !== "undefined") ? String(slug || "").trim() : "";
  if (s2) return s2;

  return "default";
}

function getLensFolderForClientPrimary() {
  return getLensFolderForClient();
}

function getLensFolderFallback() {
  return "global";
}

function normalizeSku(sku) {
  const s = String(sku || "").trim();
  if (!s) return "";
  const cleaned = s.replace(/\s+/g, "_");
  const m = cleaned.match(/(\d{5,})/);
  return m ? m[1] : cleaned;
}

function encodePathPreserveSlashes(path) {
  const clean = String(path || "").replace(/^\/+/, "");
  return clean
    .split("/")
    .map(seg => encodeURIComponent(seg))
    .join("/");
}

function buildPublicStorageUrl(pathInBucket) {
  const encodedPath = encodePathPreserveSlashes(pathInBucket);
  const base = `${SUPABASE_PROJECT_URL}/storage/v1/object/public/${STORAGE_BUCKET}/${encodedPath}`;

  const ver = (typeof window !== "undefined" && window.__ASSET_VER__) ? String(window.__ASSET_VER__) : "";
  return ver ? `${base}?v=${encodeURIComponent(ver)}` : base;
}

function buildPathsForSku(folder, sku) {
  const basePath = `lentes/${folder}/`;

  return {
    one: `${basePath}${sku}.png`,
    frame: `${basePath}${sku}_frame.png`,
    lens: `${basePath}${sku}_lens.png`,
    leftTemple: `${basePath}${sku}_left_temple.png`,
    rightTemple: `${basePath}${sku}_right_temple.png`,
    leftArm: `${basePath}${sku}_left_arm.png`,
    rightArm: `${basePath}${sku}_right_arm.png`,
    arms: `${basePath}${sku}_arms.png`,
  };
}

function isMobileForAssets() {
  return (
    (window.matchMedia && window.matchMedia("(pointer: coarse)").matches) ||
    /Android|iPhone|iPad|iPod/i.test(navigator.userAgent)
  );
}

async function loadImageSafe(url) {
  if (!url) return null;

  const u = String(url).trim();

  try {
    const res = await fetch(u, { mode: "cors", cache: "no-store" });
    if (!res.ok) throw new Error("fetch not ok: " + res.status);

    const blob = await res.blob();
    const objectUrl = URL.createObjectURL(blob);

    const img = new Image();
    img.crossOrigin = "anonymous";

    await new Promise((resolve) => {
      img.onload = resolve;
      img.onerror = resolve;
      img.src = objectUrl;
    });

    try { URL.revokeObjectURL(objectUrl); } catch {}
    try { if (img.decode) await img.decode(); } catch {}

    if (img.naturalWidth > 0) return img;

  } catch (e) {}

  return await new Promise((resolve) => {
    const img = new Image();
    img.crossOrigin = "anonymous";

    img.onload = async () => {
      try { if (img.decode) await img.decode(); } catch (e) {}
      resolve(img);
    };

    img.onerror = () => resolve(null);

    const ver = (typeof window !== "undefined" && window.__ASSET_VER__) ? String(window.__ASSET_VER__) : "";
    img.src = ver ? (u + (u.includes("?") ? "&" : "?") + "v=" + encodeURIComponent(ver)) : u;
  });
}

async function loadLensAssets(lens) {
  const skuRaw = lens?.sku || lens?.SKU || lens?.codigo || lens?.id_sku || "";
  const sku = normalizeSku(skuRaw);

  const dbImg = String(lens?.imagen_url || "").trim();

  if (!sku) {
    const img = await loadImageSafe(dbImg);
    return { type: "single", single: img };
  }

  const folderPrimary = getLensFolderForClientPrimary();
  const folderFallback = getLensFolderFallback();

  const foldersToTry = [folderPrimary];
  if (folderFallback && folderFallback !== folderPrimary) foldersToTry.push(folderFallback);

  for (const folder of foldersToTry) {
    const paths = buildPathsForSku(folder, sku);

    const urlOne = buildPublicStorageUrl(paths.one);
    const urlFrame = buildPublicStorageUrl(paths.frame);
    const urlLens = buildPublicStorageUrl(paths.lens);

    const urlArms = buildPublicStorageUrl(paths.arms);
    const urlLT = buildPublicStorageUrl(paths.leftTemple);
    const urlRT = buildPublicStorageUrl(paths.rightTemple);
    const urlLA = buildPublicStorageUrl(paths.leftArm);
    const urlRA = buildPublicStorageUrl(paths.rightArm);

    const [frameBase, lensBase] = await Promise.all([
      loadImageSafe(urlFrame),
      loadImageSafe(urlLens),
    ]);

    if (frameBase && lensBase) {
      const armsImg = await loadImageSafe(urlArms);
      if (armsImg) {
        console.log("ASSETS OK (four:arms)", { sku, folder, urlFrame, urlLens, urlArms });
        return { type: "four", frame: frameBase, lens: lensBase, arms: armsImg };
      }

      const [tL, tR, aL, aR] = await Promise.all([
        loadImageSafe(urlLT),
        loadImageSafe(urlRT),
        loadImageSafe(urlLA),
        loadImageSafe(urlRA),
      ]);

      const left = tL || aL || null;
      const right = tR || aR || null;

      if (left || right) {
        console.log("ASSETS OK (four:l/r)", { sku, folder, urlFrame, urlLens, left: !!left, right: !!right });
        return { type: "four", frame: frameBase, lens: lensBase, leftTemple: left, rightTemple: right };
      }

      console.log("ASSETS OK (two)", { sku, folder, urlFrame, urlLens });
      return { type: "two", frame: frameBase, lens: lensBase };
    }

    const one = await loadImageSafe(urlOne);
    if (one) {
      console.log("ASSETS OK (single by sku)", { sku, folder, urlOne });
      return { type: "single", single: one };
    }

    console.warn("ASSETS FAIL in folder", { sku, folder });
  }

  const dbFallback = await loadImageSafe(dbImg);
  if (dbFallback) console.log("ASSETS OK (db fallback)", { sku, dbImg });
  else console.warn("ASSETS FAIL (all fallbacks)", { sku, dbImg });

  return { type: "single", single: dbFallback };
}

let lensAssets = null;

async function loadCurrentLens() {
  if (!lentesFiltrados || !lentesFiltrados.length) return;

  const safeIndex =
    ((currentIndex % lentesFiltrados.length) + lentesFiltrados.length) % lentesFiltrados.length;

  const lens = lentesFiltrados[safeIndex];

  modelNameEl.textContent = lens?.nombre_modelo || lens?.nombre || "Modelo";

  const urlLens = pickFirstUrl(lens);
  const urlCliente = getClientDefaultUrl();
  const waPhone = getClientWhatsApp();
  const waUrl = buildWhatsAppUrl(waPhone, lens);

  const finalUrl = urlLens || urlCliente || waUrl;

  console.log("BTN DEBUG:", {
    urlLens,
    urlCliente,
    waPhone,
    finalUrl,
    idx: safeIndex,
    total: lentesFiltrados.length
  });

  if (productBtnSafe) {
    if (finalUrl) {
      productBtnSafe.classList.remove("hidden");
      productBtnSafe.style.display = "inline-flex";
      productBtnSafe.style.alignItems = "center";
      productBtnSafe.style.justifyContent = "center";

      productBtnSafe.textContent = "üõí Ver producto";
      productBtnSafe.onclick = () => window.open(finalUrl, "_blank", "noopener");
    } else {
      productBtnSafe.classList.add("hidden");
      productBtnSafe.onclick = null;
    }
  } else {
    console.warn("‚ö†Ô∏è No se encontr√≥ #productBtn en el DOM.");
  }

  lensImgReady = false;
  lensImg = null;
  lensAssets = null;

  try {
    const assets = await loadLensAssets(lens);
    lensAssets = assets;

    if (assets?.type === "single") {
      lensImg = assets.single || null;
    }

    lensImgReady = !!(
      (assets?.type === "single" && assets.single) ||
      (assets?.type === "two" && assets.frame && assets.lens) ||
      (assets?.type === "four" && assets.frame && assets.lens)
    );

    if (!lensImgReady) {
      console.warn("No se pudo cargar assets del lente:", {
        sku: lens?.sku,
        imagen_url: lens?.imagen_url,
        clientSlug: (window.__client?.slug || "")
      });
    }
  } catch (e) {
    console.warn("loadLensAssets error:", e);
    lensImgReady = false;
    lensImg = null;
    lensAssets = null;
  }
}

prevBtn.onclick = () => {
  if (!lentesFiltrados || !lentesFiltrados.length) return;
  currentIndex = (currentIndex - 1 + lentesFiltrados.length) % lentesFiltrados.length;
  loadCurrentLens().catch(err => console.warn("loadCurrentLens prev error:", err));
};

nextBtn.onclick = () => {
  if (!lentesFiltrados || !lentesFiltrados.length) return;
  currentIndex = (currentIndex + 1) % lentesFiltrados.length;
  loadCurrentLens().catch(err => console.warn("loadCurrentLens next error:", err));
};

/* =========================
   ‚úÖ CAPTURA (m√≥vil comparte / PC descarga)
========================= */
function isMobileForShare() {
  return (
    (window.matchMedia && window.matchMedia("(pointer: coarse)").matches) ||
    (navigator.maxTouchPoints && navigator.maxTouchPoints > 0 && /Android|iPhone|iPad|iPod/i.test(navigator.userAgent))
  );
}

function getCurrentLensForFilename() {
  if (!lentesFiltrados || !lentesFiltrados.length) return null;
  const safeIndex =
    ((currentIndex % lentesFiltrados.length) + lentesFiltrados.length) % lentesFiltrados.length;
  return lentesFiltrados[safeIndex] || null;
}

function canvasToBlobSafe(cnv) {
  return new Promise((resolve) => {
    try {
      cnv.toBlob((b) => resolve(b || null), "image/png", 1.0);
    } catch (e) {
      resolve(null);
    }
  });
}

function downloadBlob(blob, filename) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename || "facelens.png";
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => {
    try { URL.revokeObjectURL(url); } catch {}
  }, 1200);
}

async function doCapture() {
  try {
    const lens = getCurrentLensForFilename();
    const sku = normalizeSku(lens?.sku || lens?.SKU || lens?.codigo || lens?.id_sku || "");
    const filename = `facelens_${sku || "captura"}.png`;

    const blob = await canvasToBlobSafe(canvas);

    if (!blob) {
      alert("No pude generar la captura (canvas bloqueado por CORS o no hay imagen a√∫n).");
      return;
    }

    if (isMobileForShare() && navigator.share) {
      try {
        const file = new File([blob], filename, { type: "image/png" });
        const can = navigator.canShare ? navigator.canShare({ files: [file] }) : true;

        if (can) {
          await navigator.share({
            files: [file],
            title: "FaceLens",
            text: "Mir√° c√≥mo me quedan estos lentes üòé",
          });
          return;
        }
      } catch (e) {}
    }

    downloadBlob(blob, filename);

  } catch (e) {
    console.warn("Captura error:", e);
    alert("No pude sacar la captura.");
  }
}

if (captureBtn) {
  captureBtn.onclick = () => { doCapture(); };
}

/* =========================
   7) AR (FaceMesh + suavizado + zoom robusto en m√≥vil sin romper PC)
========================= */
function startAR() {
  const faceMesh = new FaceMesh({
    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`,
  });

  faceMesh.setOptions({
    maxNumFaces: 1,
    refineLandmarks: true,
    minDetectionConfidence: 0.6,
    minTrackingConfidence: 0.6,
    selfieMode: true,
  });

  let smoothX = null, smoothY = null, smoothA = null;
  let smoothD = null;
  let smoothW = null;
  const lerp = (a,b,t)=>a+(b-a)*t;
  const normAngle = (a)=>Math.atan2(Math.sin(a), Math.cos(a));

  function isMobileDevice() {
    const w = Math.min(window.innerWidth || 9999, (screen && screen.width) || 9999);
    return (
      w <= 820 ||
      window.matchMedia?.("(pointer: coarse)")?.matches ||
      /Android|iPhone|iPad|iPod/i.test(navigator.userAgent)
    );
  }

  function getLensScaleDefault() { return isMobileDevice() ? 1.15 : 0.90; }
  function getLensScale() {
    const v = Number(window.__LENS_SCALE__);
    return Number.isFinite(v) && v > 0 ? v : getLensScaleDefault();
  }

  function softClamp(x, lo, hi) {
    if (x <= lo) return lo;
    if (x >= hi) return hi;
    const t = (x - lo) / (hi - lo);
    const s = t * t * (3 - 2 * t);
    return lo + (hi - lo) * s;
  }

  function clamp01(x){ return Math.max(0, Math.min(1, x)); }
  function smoothstep01(t){ return t*t*(3 - 2*t); }

  function getParams(mobile) {
    if (mobile) {
      return {
        Tpos: 0.18,
        Td: 0.14,
        Tw: 0.28,
        baseFactor: 1.90,
        minWRatio: 0.16,
        maxWRatio: 0.84,
        nearStart: 0.18,
        nearEnd:   0.28,
        nearBrake: 0.74
      };
    }

    return {
      Tpos: 0.18,
      Td: 0.16,
      Tw: 0.18,
      baseFactor: 1.85,
      minWpx: 110,
      maxWRatio: 0.30,
      nearStart: 0.18,
      nearEnd:   0.28,
      nearBrake: 0.78
    };
  }

  faceMesh.onResults((results) => {
    if (!video.videoWidth || !video.videoHeight) return;

    const mobile = isMobileDevice();

    if (mobile) {
      const rect = canvas.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;

      const cw = Math.max(1, Math.round(rect.width * dpr));
      const ch = Math.max(1, Math.round(rect.height * dpr));

      if (canvas.width !== cw || canvas.height !== ch) {
        canvas.width = cw;
        canvas.height = ch;
      }
    } else {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
    }

    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(results.image, 0,0,canvas.width,canvas.height);

    const faces = results.multiFaceLandmarks;
    if (!faces || !faces.length) return;

    const canLayered =
      (typeof window.__drawARLayered === "function") &&
      (typeof lensAssets !== "undefined") &&
      lensAssets &&
      (lensAssets.type === "two" || lensAssets.type === "four");

    if (!canLayered) {
      if (!lensImgReady || !lensImg || lensImg.naturalWidth === 0) return;
    }

    const lm = faces[0];
    const L = lm[33];
    const R = lm[263];
    const N = lm[168];

    const lx = L.x * canvas.width;
    const ly = L.y * canvas.height;
    const rx = R.x * canvas.width;
    const ry = R.y * canvas.height;
    const nx = N.x * canvas.width;
    const ny = N.y * canvas.height;

    const dx = rx - lx;
    const dy = ry - ly;

    const eyeDistPx = Math.hypot(dx, dy);
    const angle = Math.atan2(dy, dx);

    const targetX = nx;
    const targetY = ny + eyeDistPx * 0.06;

    const P = getParams(mobile);
    const scale = getLensScale();

    if (smoothX === null) {
      smoothX = targetX;
      smoothY = targetY;
      smoothA = angle;
      smoothD = eyeDistPx;
      smoothW = null;
    } else {
      smoothX = lerp(smoothX, targetX, P.Tpos);
      smoothY = lerp(smoothY, targetY, P.Tpos);

      const da = normAngle(angle - smoothA);
      smoothA = normAngle(smoothA + da * P.Tpos);

      smoothD = lerp(smoothD, eyeDistPx, P.Td);
    }

    let desiredW;
    let minW, maxW;

    if (mobile) {
      let baseW = smoothD * P.baseFactor * scale;

      const dRatio = smoothD / Math.max(1, canvas.width);
      const tNearRaw = (dRatio - P.nearStart) / (P.nearEnd - P.nearStart);
      const tNear = smoothstep01(clamp01(tNearRaw));
      const brake = 1 - tNear * (1 - P.nearBrake);
      baseW *= brake;

      minW = canvas.width * P.minWRatio;
      maxW = canvas.width * P.maxWRatio;

      desiredW = softClamp(baseW, minW, maxW);

    } else {
      let baseW = smoothD * P.baseFactor * scale;

      const dRatio = smoothD / Math.max(1, canvas.width);
      const tNearRaw = (dRatio - P.nearStart) / (P.nearEnd - P.nearStart);
      const tNear = Math.max(0, Math.min(1, tNearRaw));
      const tNearSmooth = tNear * tNear * (3 - 2 * tNear);
      const brake = 1 - tNearSmooth * (1 - P.nearBrake);
      baseW *= brake;

      minW = P.minWpx;
      maxW = canvas.width * P.maxWRatio;

      desiredW = softClamp(baseW, minW, maxW);
    }

    if (smoothW === null) smoothW = desiredW;
    else smoothW = lerp(smoothW, desiredW, P.Tw);

    const targetW = smoothW;

    if (canLayered) {
      try {
        const res = window.__drawARLayered(ctx, { x: smoothX, y: smoothY, angle: smoothA, w: targetW });
        if (res !== false) return;
      } catch (e) {}
    }

    if (!lensImgReady || !lensImg || lensImg.naturalWidth === 0) return;

    const aspect = lensImg.naturalHeight / lensImg.naturalWidth;
    const targetH = targetW * aspect;

    ctx.save();
    ctx.translate(smoothX, smoothY);
    ctx.rotate(smoothA);
    ctx.drawImage(lensImg, -targetW/2, -targetH/2, targetW, targetH);
    ctx.restore();
  });

  const camera = new Camera(video, {
    onFrame: async () => { await faceMesh.send({ image: video }); },
    width: 1280,
    height: 720,
  });

  camera.start();
}

/* =========================
     INIT
========================= */
(async function () {
  try {
    console.log("INIT ‚úÖ arranc√≥");

    if (typeof loadClientConfig !== "function") {
      throw new Error("loadClientConfig() no est√° definida");
    }

    if (typeof startAR !== "function") {
      throw new Error("startAR() no est√° definida");
    }

    await loadClientConfig();
    console.log("loadClientConfig ‚úÖ OK");

    if (typeof aplicarFiltro === "function") {
      aplicarFiltro();
      console.log("aplicarFiltro ‚úÖ OK");
    } else if (typeof loadCurrentLens === "function") {
      loadCurrentLens();
      console.log("loadCurrentLens (sin filtro) ‚úÖ OK");
    }

    startAR();
    console.log("startAR ‚úÖ OK");

  } catch (e) {
    console.error("INIT ‚ùå", e);
    alert(e.message || String(e));
  }
})();
  </script>

  <!-- ‚úÖ Consola en el celular (ERUDA) -->
  <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
  <script>
    eruda.init();
    console.log("ERUDA ‚úÖ lista");
  </script>

</body>
</html>