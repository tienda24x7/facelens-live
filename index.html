<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FaceLens Live</title>

  <!-- ‚úÖ Android browser UI color (se actualizar√° por JS si hay branding) -->
  <meta name="theme-color" content="#0f0f0f" />

  <!-- MediaPipe -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <!-- Supabase CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* =========================
       ‚úÖ BRAND DEFAULT (no rompe nada)
    ========================= */
    :root{
      --brand-primary: #0f0f0f;        /* fondo base */
      --brand-surface: rgba(0,0,0,.60);/* panel UI */
      --brand-accent: #ffffff;         /* acento (texto/botones) */
      --brand-muted: #333333;          /* secundarios */
      --brand-on-primary: #ffffff;     /* texto sobre primary/surface */
    }

    body { margin:0; background:var(--brand-primary); color:var(--brand-on-primary); font-family:Arial }

    #container { position:relative; width:100vw; height:100vh }
    video, canvas { position:absolute; width:100%; height:100%; object-fit:cover }

    /* ‚úÖ Logo arriba (overlay seguro) */
    #brandBar{
      position:fixed;
      top:0; left:0; right:0;
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      pointer-events:none; /* no bloquea clicks */
      z-index:10;
    }
    #brandLogo{
      height:32px;
      display:none; /* se muestra cuando carga */
      pointer-events:none;
      filter: drop-shadow(0 2px 6px rgba(0,0,0,.55));
    }
    #brandTitle{
      font-weight:bold;
      opacity:.92;
      text-shadow: 0 2px 6px rgba(0,0,0,.55);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:70vw;
      display:none; /* opcional: se activa si hay nombre de marca */
    }

    #ui { position:fixed; bottom:0; left:0; right:0; padding:12px; background:var(--brand-surface); z-index:9 }

    button, select { padding:10px 12px; border:none; border-radius:10px; font-weight:bold; cursor:pointer }

    /* ‚úÖ Bot√≥n primario (si alg√∫n d√≠a lo us√°s) */
    button.primary { background:var(--brand-accent); color:#000; }

    /* ‚úÖ Secundarios (como ya ven√≠as usando) */
    button.secondary, select { background:var(--brand-muted); color:var(--brand-on-primary) }

    button.hidden { display:none }

    #modelName { flex:1; text-align:center; font-weight:bold; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
  </style>
</head>

<body>
  <!-- ‚úÖ BRAND BAR (no rompe nada, queda arriba) -->
  <div id="brandBar">
    <img id="brandLogo" alt="Logo" />
    <div id="brandTitle"></div>
  </div>

  <div id="container">
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas"></canvas>
  </div>

  <div id="ui">
    <!-- Filtro -->
    <select id="categoryFilter" style="width:100%;">
      <option value="all">Todos</option>
      <option value="clasicos">Cl√°sicos</option>
      <option value="degrade">Degrad√©</option>
      <option value="espejados">Espejados</option>
      <option value="polarizados">Polarizados</option>
      <option value="ferrari">Ferrari</option>
    </select>

    <!-- Navegaci√≥n -->
    <div style="display:flex; gap:10px; margin-top:10px; align-items:center;">
      <button id="prevBtn" class="secondary" style="min-width:44px;">‚óÄ</button>
      <span id="modelName">Cargando‚Ä¶</span>
      <button id="nextBtn" class="secondary" style="min-width:44px;">‚ñ∂</button>
    </div>

    <!-- Acciones -->
    <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
      <button id="captureBtn" class="secondary">üì∏ Captura</button>
      <button id="productBtn" class="hidden">üõí Ver producto</button>
    </div>
  </div>

  <script>  
/* =========================
     0) SUPABASE
  ========================= */
const SUPABASE_URL = "https://romgbrobvperljaviekj.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJvbWdicm9idnBlcmxqYXZpZWtqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3MTQ1MTMsImV4cCI6MjA4MjI5MDUxM30.WIpN_Hj0C70bD3Q-Bnxk4tfdgJRr8NnQwmJdM3C5HuI";
const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* =========================
   1) SLUG
========================= */
const slug =
  new URLSearchParams(location.search).get("slug") ||
  (location.pathname || "/").replace(/^\/+|\/+$/g, "") ||
  "tienda24x7_demo";

/* =========================
   2) UI
========================= */
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const modelNameEl = document.getElementById("modelName");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const captureBtn = document.getElementById("captureBtn");
const productBtn = document.getElementById("productBtn");
const categoryFilter = document.getElementById("categoryFilter");

/* =========================
   3) ESTADO
========================= */
let cliente = null;
let lentes = [];
let lentesFiltrados = [];
let currentIndex = 0;

let lensImg = null;
let lensImgReady = false;

/* =========================
   4) CARGA CONFIG (cliente + lentes por plan)
========================= */

// Helpers para cliente (se usan en bloque 4/6)
function normalizePhone(phone) {
  return String(phone || "").replace(/[^\d]/g, "");
}

// Regla simple:
// - Si el cliente pone pa√≠s (ej: 549..., 54..., 598..., 1..., etc) => lo respeta
// - Si pone un n√∫mero "local" (corto) => asumimos Argentina y le anteponemos 549
function normalizeWhatsApp(phone) {
  const p = normalizePhone(phone);
  if (!p) return "";
  if (p.startsWith("54") || p.length >= 12) return p;
  return `549${p}`;
}

function pickFirstClientUrl(cliente) {
  const c = cliente || {};
  const candidates = [
    c.product_url,
    c.productUrl,
    c.ml_url,
    c.mercadolibre_url,
    c.web_url,
    c.tienda_url,
    c.url,
    c.link,
  ];
  for (const u of candidates) {
    if (typeof u === "string" && u.trim()) return u.trim();
  }
  return "";
}

// Helper: obtiene ids de lente desde la tabla lentes_catalogos (soporta distintos nombres)
function pickLensId(row) {
  return (
    row?.lente_id ||
    row?.lens_id ||
    row?.id_lente ||
    row?.lente ||
    row?.lens ||
    null
  );
}

/* =========================
   ‚úÖ BRANDING helpers (logo + colores por cliente)
   - Soporta columnas sueltas (logo_url, primary_color, etc)
   - Soporta JSON en cliente.brand / cliente.branding / cliente.marca
========================= */
function getBrandFromClient(cliente) {
  const c = cliente || {};
  const b = c.brand || c.branding || c.marca || {}; // JSON opcional

  return {
    name:
      b.name || b.nombre || c.brand_name || c.nombre_marca || c.nombre || c.name || "",

    logoUrl:
      b.logo_url || b.logoUrl || c.logo_url || c.brand_logo_url || c.logo || "",

    // Si guard√°s path en Storage (bucket p√∫blico)
    logoPath:
      b.logo_path || b.logoPath || c.logo_path || c.brand_logo_path || "",

    logoBucket:
      b.logo_bucket || c.logo_bucket || c.brand_logo_bucket || "branding",

    primary:
      b.primary_color || b.primary || c.primary_color || c.brand_primary || "",

    surface:
      b.surface_color || b.surface || c.surface_color || c.brand_surface || "",

    accent:
      b.accent_color || b.accent || c.accent_color || c.brand_accent || "",

    muted:
      b.muted_color || b.muted || c.muted_color || c.brand_muted || "",

    onPrimary:
      b.on_primary || b.text_on_primary || c.on_primary || c.brand_on_primary || ""
  };
}

// Solo sirve si el bucket es PUBLIC
function resolveLogoUrlFromStorage(db, bucket, path) {
  try {
    if (!db?.storage?.from || !bucket || !path) return "";
    const { data } = db.storage.from(bucket).getPublicUrl(path);
    return data?.publicUrl || "";
  } catch {
    return "";
  }
}

function applyBrandingFromClient(db, cliente) {
  const brand = getBrandFromClient(cliente);

  // 1) Colores (CSS variables)
  const root = document.documentElement;
  if (brand.primary)   root.style.setProperty("--brand-primary", brand.primary);
  if (brand.surface)   root.style.setProperty("--brand-surface", brand.surface);
  if (brand.accent)    root.style.setProperty("--brand-accent", brand.accent);
  if (brand.muted)     root.style.setProperty("--brand-muted", brand.muted);
  if (brand.onPrimary) root.style.setProperty("--brand-on-primary", brand.onPrimary);

  // 2) theme-color (Android barra superior)
  if (brand.primary) {
    let meta = document.querySelector('meta[name="theme-color"]');
    if (!meta) {
      meta = document.createElement("meta");
      meta.setAttribute("name", "theme-color");
      document.head.appendChild(meta);
    }
    meta.setAttribute("content", brand.primary);
  }

  // 3) T√≠tulo (opcional)
  const titleEl = document.getElementById("brandTitle");
  if (titleEl) {
    if (brand.name) {
      titleEl.textContent = brand.name;
      titleEl.style.display = "block";
    } else {
      titleEl.style.display = "none";
    }
  }

  // 4) Logo
  const logoEl = document.getElementById("brandLogo");
  if (logoEl) {
    let logoUrl = brand.logoUrl || "";
    if (!logoUrl && brand.logoPath) {
      logoUrl = resolveLogoUrlFromStorage(db, brand.logoBucket, brand.logoPath);
    }

    if (logoUrl) {
      // cache bust para m√≥viles
      const ver = window.__ASSET_VER__ ? `v=${window.__ASSET_VER__}` : `v=${Date.now()}`;
      const src = logoUrl.includes("?") ? `${logoUrl}&${ver}` : `${logoUrl}?${ver}`;

      logoEl.onload = () => { logoEl.style.display = "inline-block"; };
      logoEl.onerror = () => {
        console.warn("Logo no carg√≥:", logoUrl);
        logoEl.style.display = "none";
      };
      logoEl.src = src;
    } else {
      logoEl.style.display = "none";
    }
  }

  console.log("BRANDING ‚úÖ aplicado", brand);
}

async function loadClientConfig() {
  // =========================
  // 1) Cliente por slug
  // =========================
  const { data: cData, error: cErr } = await db
    .from("clientes_facelens")
    .select("*")
    .eq("slug", slug)
    .limit(1);

  if (cErr) throw new Error("Error leyendo clientes: " + cErr.message);
  if (!cData || cData.length === 0) throw new Error("No existe el cliente para slug: " + slug);

  cliente = cData[0];

  // ‚úÖ Branding (quir√∫rgico): aplica logo + colores apenas tenemos el cliente
  window.__ASSET_VER__ = Date.now();
  try { applyBrandingFromClient(db, cliente); } catch (e) { console.warn("Branding fall√≥:", e); }

  // Guardar cliente global para que lo use el bot√≥n/whatsapp
  window.__client = cliente || {};
  window.__client.whatsapp_norm = normalizeWhatsApp(window.__client.whatsapp || window.__client.WhatsApp || "");
  window.__client.default_url = pickFirstClientUrl(window.__client);

  // Plan del cliente
  const planRaw = String(cliente.plan || "ALL").trim();
  const plan = planRaw.toUpperCase();

  // Base query de lentes (siempre del cliente y activos)
  const baseQ = () =>
    db
      .from("lentes")
      .select("*")
      .eq("cliente_id", cliente.id)
      .eq("activo", true);

  // =========================
  // 2) Traer lentes seg√∫n plan
  // =========================
  let gData = [];
  let mode = "ALL";

  if (plan === "A" || plan === "B") {
    // Legacy por grupo
    mode = `GRUPO_${plan}`;
    const { data, error } = await baseQ().eq("grupo", plan);
    if (error) throw new Error("Error leyendo lentes: " + error.message);
    gData = data || [];

  } else if (plan === "ALL") {
    // ALL = todos los lentes del cliente (sin depender de grupo)
    mode = "ALL";
    const { data, error } = await baseQ();
    if (error) throw new Error("Error leyendo lentes: " + error.message);
    gData = data || [];

  } else {
    // Modo cat√°logo: el plan puede ser "NICOLAS" o "EZEQUIEL"
    // o varios separados por coma: "NICOLAS,EZEQUIEL"
    const catalogos = plan
      .split(",")
      .map(s => s.trim())
      .filter(Boolean);

    mode = `CATALOGOS_${catalogos.join("_")}`;

    // 1) buscar asignaciones en lentes_catalogos por catalogo
    const { data: mapData, error: mapErr } = await db
      .from("lentes_catalogos")
      .select("*")
      .in("catalogo", catalogos);

    if (mapErr) throw new Error("Error leyendo lentes_catalogos: " + mapErr.message);

    const lensIds = (mapData || [])
      .map(pickLensId)
      .filter(Boolean);

    // 2) traer lentes por ids + cliente_id
    if (lensIds.length) {
      const { data, error } = await baseQ().in("id", lensIds);
      if (error) throw new Error("Error leyendo lentes por cat√°logo: " + error.message);
      gData = data || [];
    } else {
      gData = [];
    }

    // Guardamos para debug
    window.__client.catalogos = catalogos;
  }

  lentes = gData || [];

  if (!lentes.length) {
    modelNameEl.textContent = "Sin lentes cargados";
  }

  console.log("CLIENTE GLOBAL ‚úÖ", window.__client);
  console.log("SLUG:", slug, "PLAN:", plan, "MODO:", mode, "LENTES:", lentes.length);

  return { cliente, plan, lentes, mode };
}

/* =========================
   5) FILTRO
========================= */

/**
 * WRAP seguro: cuando se ejecute loadClientConfig(), guardamos
 * el cliente en window.__client para que el bot√≥n WhatsApp funcione.
 * NO rompe nada aunque loadClientConfig no devuelva nada.
 */
(function wrapLoadClientConfig() {
  if (typeof loadClientConfig !== "function") return;
  if (loadClientConfig.__wrapped) return;

  const _orig = loadClientConfig;

  // helper interno
  function setClientGlobal(maybeResult) {
    // buscamos por prioridad: return -> globals existentes -> {}.
    const candidate =
      (maybeResult && (maybeResult.cliente || maybeResult.client || maybeResult.config)) ||
      maybeResult ||
      window.clientConfig ||
      window.cliente ||
      window.config ||
      window.__client ||
      {};

    window.__client = candidate;
    console.log("CLIENTE GLOBAL ‚úÖ", window.__client);
  }

  loadClientConfig = async function (...args) {
    const res = await _orig.apply(this, args);
    try {
      setClientGlobal(res);
    } catch (e) {
      // no cortamos la app por esto
      console.warn("No pude setear window.__client:", e);
    }
    return res;
  };

  loadClientConfig.__wrapped = true;
})();

function aplicarFiltro() {
  const categoria = (categoryFilter?.value || "all").toLowerCase().trim();

  if (categoria === "all") {
    lentesFiltrados = [...lentes];
  } else {
    lentesFiltrados = lentes.filter(l =>
      String(l.categoria || "").toLowerCase().trim() === categoria
    );
  }

  currentIndex = 0;

  if (!lentesFiltrados.length) {
    modelNameEl.textContent = "Sin lentes en esta categor√≠a";
    lensImgReady = false;
    productBtn.classList.add("hidden");
    productBtn.onclick = null;
    return;
  }

  // IMPORTANTE: mostrar el primer lente del filtro sin "saltar"
  loadCurrentLens();
}

categoryFilter.onchange = aplicarFiltro;

/* =========================
   6) LENTES (carga imagen + bot√≥n producto)
========================= */

// Asegurar referencia al bot√≥n sin romper nada
const productBtnSafe = (typeof productBtn !== "undefined" && productBtn)
  ? productBtn
  : document.getElementById("productBtn");

function buildWhatsAppUrl(phone, lens) {
  const p = normalizePhone(phone);
  if (!p) return "";

  const model = String(lens?.nombre_modelo || lens?.nombre || "").trim();
  const msg = model
    ? `Hola! Quiero consultar por el modelo: ${model}`
    : `Hola! Quiero consultar por un modelo de lentes.`;

  return `https://wa.me/${p}?text=${encodeURIComponent(msg)}`;
}

function pickFirstUrlFromCandidates(candidates) {
  for (const u of candidates) {
    if (typeof u === "string" && u.trim()) return u.trim();
  }
  return "";
}

function pickFirstUrl(lens) {
  return pickFirstUrlFromCandidates([
    lens?.product_url,
    lens?.productUrl,
    lens?.ml_url,
    lens?.mercadolibre_url,
    lens?.web_url,
    lens?.tienda_url,
    lens?.url,
  ]);
}

function getClientWhatsApp() {
  const c = window.__client || {};
  const wa = c.whatsapp_norm || c.whatsapp || c.WhatsApp || "";
  return String(wa || "").trim();
}

function getClientDefaultUrl() {
  const c = window.__client || {};
  return pickFirstUrlFromCandidates([
    c.default_url,
    c.defaultUrl,
    c.cliente_url,
    c.product_url,
    c.productUrl,
    c.ml_url,
    c.mercadolibre_url,
    c.web_url,
    c.tienda_url,
    c.url,
    c.link,
  ]);
}

/* =========================
   ‚úÖ helpers para URLs Storage por SKU
========================= */

// Base Supabase
const SUPABASE_PROJECT_URL = "https://romgbrobvperljaviekj.supabase.co";
const STORAGE_BUCKET = "facelens-assets";

// Folder principal por cliente (slug)
function getLensFolderForClient() {
  const c = window.__client || {};

  // 1) prioridad: __client.slug
  const s1 = String(c.slug || "").trim();
  if (s1) return s1;

  // 2) fallback: variable global "slug" (la que ya us√°s en el proyecto)
  const s2 = (typeof slug !== "undefined") ? String(slug || "").trim() : "";
  if (s2) return s2;

  // 3) √∫ltimo fallback
  return "default";
}

// ‚úÖ COMPAT: si en alg√∫n lugar qued√≥ el nombre viejo, no rompe
function getLensFolderForClientPrimary() {
  return getLensFolderForClient();
}

// Folder fallback (si no existe en slug)
function getLensFolderFallback() {
  // Pod√©s cambiar "global" por el que est√©s usando
  return "global";
}

// Normaliza SKU tipo "100101", "SKU_100101", "100101 app" -> "100101"
function normalizeSku(sku) {
  const s = String(sku || "").trim();
  if (!s) return "";
  const cleaned = s.replace(/\s+/g, "_");
  const m = cleaned.match(/(\d{5,})/); // 100101, 100565, etc.
  return m ? m[1] : cleaned;
}

// ‚úÖ codifica cada parte del path (evita 400 por caracteres raros)
function encodePathPreserveSlashes(path) {
  const clean = String(path || "").replace(/^\/+/, "");
  return clean
    .split("/")
    .map(seg => encodeURIComponent(seg))
    .join("/");
}

// ‚úÖ arma URL p√∫blica (con path seguro) + cache-bust opcional
function buildPublicStorageUrl(pathInBucket) {
  const encodedPath = encodePathPreserveSlashes(pathInBucket);
  const base = `${SUPABASE_PROJECT_URL}/storage/v1/object/public/${STORAGE_BUCKET}/${encodedPath}`;

  // Si quer√©s forzar recarga (√∫til en m√≥vil): window.__ASSET_VER__ = "1"
  const ver = (typeof window !== "undefined" && window.__ASSET_VER__) ? String(window.__ASSET_VER__) : "";
  return ver ? `${base}?v=${encodeURIComponent(ver)}` : base;
}

// candidatos de paths para un SKU dentro de un folder
function buildPathsForSku(folder, sku) {
  const basePath = `lentes/${folder}/`;

  return {
    one: `${basePath}${sku}.png`,
    frame: `${basePath}${sku}_frame.png`,
    lens: `${basePath}${sku}_lens.png`,
    leftTemple: `${basePath}${sku}_left_temple.png`,
    rightTemple: `${basePath}${sku}_right_temple.png`,
    leftArm: `${basePath}${sku}_left_arm.png`,
    rightArm: `${basePath}${sku}_right_arm.png`,
    arms: `${basePath}${sku}_arms.png`,
  };
}

// ‚úÖ Detecto m√≥vil ‚Äúsimple‚Äù
function isMobileForAssets() {
  return (
    (window.matchMedia && window.matchMedia("(pointer: coarse)").matches) ||
    /Android|iPhone|iPad|iPod/i.test(navigator.userAgent)
  );
}

// ‚úÖ Carga imagen sin romper nada (fix m√≥vil: NO crossOrigin + decode)
function loadImageSafe(url) {
  return new Promise((resolve) => {
    if (!url) return resolve(null);

    const u = String(url).trim();

    const img = new Image();

    // ‚úÖ PC: mantenemos crossOrigin como antes
    // ‚úÖ M√≥vil: NO seteamos crossOrigin (Safari/Chrome m√≥vil suelen fallar si lo pon√©s)
    if (!isMobileForAssets()) {
      img.crossOrigin = "anonymous";
    }

    img.onload = async () => {
      // ‚úÖ Safari: a veces ‚Äúcarga‚Äù pero no dibuja bien si no decodific√°s
      try {
        if (img.decode) await img.decode();
      } catch (e) {
        // si decode falla, igual seguimos
      }
      resolve(img);
    };

    img.onerror = () => resolve(null);

    // ‚úÖ (Opcional) Si quer√©s reventar cache en m√≥vil: window.__ASSET_VER__ = String(Date.now())
    const ver = (typeof window !== "undefined" && window.__ASSET_VER__) ? String(window.__ASSET_VER__) : "";
    img.src = ver ? (u + (u.includes("?") ? "&" : "?") + "v=" + encodeURIComponent(ver)) : u;
  });
}

// Intenta detectar autom√°ticamente 4/3/2/1 PNG en 2 folders (slug y fallback)
async function loadLensAssets(lens) {
  const skuRaw = lens?.sku || lens?.SKU || lens?.codigo || lens?.id_sku || "";
  const sku = normalizeSku(skuRaw);

  const dbImg = String(lens?.imagen_url || "").trim();

  // Sin SKU ‚Üí imagen_url DB
  if (!sku) {
    const img = await loadImageSafe(dbImg);
    return { type: "single", single: img };
  }

  // ‚úÖ us√° primary ‚Äúreal‚Äù (y si alguien llama al viejo, igual funciona)
  const folderPrimary = getLensFolderForClientPrimary();
  const folderFallback = getLensFolderFallback();

  // armamos candidatos (primero slug, luego global)
  const foldersToTry = [folderPrimary];
  if (folderFallback && folderFallback !== folderPrimary) foldersToTry.push(folderFallback);

  for (const folder of foldersToTry) {
    const paths = buildPathsForSku(folder, sku);

    // URLs
    const urlOne = buildPublicStorageUrl(paths.one);
    const urlFrame = buildPublicStorageUrl(paths.frame);
    const urlLens = buildPublicStorageUrl(paths.lens);

    const urlArms = buildPublicStorageUrl(paths.arms);
    const urlLT = buildPublicStorageUrl(paths.leftTemple);
    const urlRT = buildPublicStorageUrl(paths.rightTemple);
    const urlLA = buildPublicStorageUrl(paths.leftArm);
    const urlRA = buildPublicStorageUrl(paths.rightArm);

    // 1) Probar frame + lens
    const [frameBase, lensBase] = await Promise.all([
      loadImageSafe(urlFrame),
      loadImageSafe(urlLens),
    ]);

    if (frameBase && lensBase) {
      // arms √∫nica
      const armsImg = await loadImageSafe(urlArms);
      if (armsImg) {
        console.log("ASSETS OK (four:arms)", { sku, folder, urlFrame, urlLens, urlArms });
        return { type: "four", frame: frameBase, lens: lensBase, arms: armsImg };
      }

      // left/right
      const [tL, tR, aL, aR] = await Promise.all([
        loadImageSafe(urlLT),
        loadImageSafe(urlRT),
        loadImageSafe(urlLA),
        loadImageSafe(urlRA),
      ]);

      const left = tL || aL || null;
      const right = tR || aR || null;

      if (left || right) {
        console.log("ASSETS OK (four:l/r)", { sku, folder, urlFrame, urlLens, left: !!left, right: !!right });
        return { type: "four", frame: frameBase, lens: lensBase, leftTemple: left, rightTemple: right };
      }

      console.log("ASSETS OK (two)", { sku, folder, urlFrame, urlLens });
      return { type: "two", frame: frameBase, lens: lensBase };
    }

    // 2) fallback 1PNG
    const one = await loadImageSafe(urlOne);
    if (one) {
      console.log("ASSETS OK (single by sku)", { sku, folder, urlOne });
      return { type: "single", single: one };
    }

    // si fall√≥ en este folder, probamos el siguiente
    console.warn("ASSETS FAIL in folder", { sku, folder });
  }

  // 3) fallback final a imagen_url DB
  const dbFallback = await loadImageSafe(dbImg);
  if (dbFallback) {
    console.log("ASSETS OK (db fallback)", { sku, dbImg });
  } else {
    console.warn("ASSETS FAIL (all fallbacks)", { sku, dbImg });
  }
  return { type: "single", single: dbFallback };
}

/* =========================
   ‚úÖ variables globales para el render (compatibles con lo actual)
   (NO redeclaramos lensImgReady / lensImg, ya viven en bloque 3)
========================= */
let lensAssets = null; // {type:'single'|'two'|'four', ...}

async function loadCurrentLens() {
  if (!lentesFiltrados || !lentesFiltrados.length) return;

  const safeIndex =
    ((currentIndex % lentesFiltrados.length) + lentesFiltrados.length) % lentesFiltrados.length;

  const lens = lentesFiltrados[safeIndex];

  modelNameEl.textContent = lens?.nombre_modelo || lens?.nombre || "Modelo";

  // =========================
  // Bot√≥n "Ver producto" (Prioridad: Lente > Cliente > WhatsApp)
  // =========================
  const urlLens = pickFirstUrl(lens);
  const urlCliente = getClientDefaultUrl();
  const waPhone = getClientWhatsApp();
  const waUrl = buildWhatsAppUrl(waPhone, lens);

  const finalUrl = urlLens || urlCliente || waUrl;

  console.log("BTN DEBUG:", {
    urlLens,
    urlCliente,
    waPhone,
    finalUrl,
    idx: safeIndex,
    total: lentesFiltrados.length
  });

  if (productBtnSafe) {
    if (finalUrl) {
      productBtnSafe.classList.remove("hidden");
      productBtnSafe.style.display = "inline-flex";
      productBtnSafe.style.alignItems = "center";
      productBtnSafe.style.justifyContent = "center";

      productBtnSafe.textContent = "üõí Ver producto";
      productBtnSafe.onclick = () => window.open(finalUrl, "_blank", "noopener");
    } else {
      productBtnSafe.classList.add("hidden");
      productBtnSafe.onclick = null;
    }
  } else {
    console.warn("‚ö†Ô∏è No se encontr√≥ #productBtn en el DOM.");
  }

  // =========================
  // ‚úÖ Imagen (multi-PNG con fallback)
  // =========================
  lensImgReady = false;
  lensImg = null;
  lensAssets = null;

  try {
    const assets = await loadLensAssets(lens);
    lensAssets = assets;

    // compatibilidad: si es single, seteamos lensImg
    if (assets?.type === "single") {
      lensImg = assets.single || null;
    }

    lensImgReady = !!(
      (assets?.type === "single" && assets.single) ||
      (assets?.type === "two" && assets.frame && assets.lens) ||
      (assets?.type === "four" && assets.frame && assets.lens)
    );

    if (!lensImgReady) {
      console.warn("No se pudo cargar assets del lente:", {
        sku: lens?.sku,
        imagen_url: lens?.imagen_url,
        clientSlug: (window.__client?.slug || "")
      });
    }
  } catch (e) {
    console.warn("loadLensAssets error:", e);
    lensImgReady = false;
    lensImg = null;
    lensAssets = null;
  }
}

/* Navegaci√≥n */
prevBtn.onclick = () => {
  if (!lentesFiltrados || !lentesFiltrados.length) return;
  currentIndex = (currentIndex - 1 + lentesFiltrados.length) % lentesFiltrados.length;
  loadCurrentLens().catch(err => console.warn("loadCurrentLens prev error:", err));
};

nextBtn.onclick = () => {
  if (!lentesFiltrados || !lentesFiltrados.length) return;
  currentIndex = (currentIndex + 1) % lentesFiltrados.length;
  loadCurrentLens().catch(err => console.warn("loadCurrentLens next error:", err));
};

/* ========================= 
   7) AR (FaceMesh + suavizado + zoom robusto en m√≥vil sin romper PC)
========================= */
function startAR() {
  const faceMesh = new FaceMesh({
    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`,
  });

  faceMesh.setOptions({
    maxNumFaces: 1,
    refineLandmarks: true,
    minDetectionConfidence: 0.6,
    minTrackingConfidence: 0.6,
    selfieMode: true,
  });

  let smoothX = null, smoothY = null, smoothA = null;
  let smoothD = null;   // eyeDist suavizado (px)
  let smoothW = null;   // ancho final suavizado (px)
  const lerp = (a,b,t)=>a+(b-a)*t;
  const normAngle = (a)=>Math.atan2(Math.sin(a), Math.cos(a));

  // Perfil dispositivo
  function isMobileDevice() {
    const w = Math.min(window.innerWidth || 9999, (screen && screen.width) || 9999);
    return (
      w <= 820 ||
      window.matchMedia?.("(pointer: coarse)")?.matches ||
      /Android|iPhone|iPad|iPod/i.test(navigator.userAgent)
    );
  }

  // Override opcional desde consola:
  // window.__LENS_SCALE__ = 1.0 / 1.2 / 1.4 ...
  function getLensScaleDefault() {
    return isMobileDevice() ? 1.15 : 0.90;
  }
  function getLensScale() {
    const v = Number(window.__LENS_SCALE__);
    return Number.isFinite(v) && v > 0 ? v : getLensScaleDefault();
  }

  // Soft-clamp (suaviza l√≠mites, no ‚Äúplancha‚Äù en seco)
  function softClamp(x, lo, hi) {
    if (x <= lo) return lo;
    if (x >= hi) return hi;
    const t = (x - lo) / (hi - lo);         // 0..1
    const s = t * t * (3 - 2 * t);          // smoothstep
    return lo + (hi - lo) * s;
  }

  // Helpers
  function clamp01(x){ return Math.max(0, Math.min(1, x)); }
  function smoothstep01(t){ return t*t*(3 - 2*t); }

  // Params por dispositivo (usa el mobile ya detectado, no recalcula)
  function getParams(mobile) {
    if (mobile) {
      return {
        // Pose
        Tpos: 0.18,
        // Suavizado de distancia
        Td: 0.14,
        // Zoom smoothing
        Tw: 0.28,

        // ‚úÖ M√ìVIL: multiplicador de eyeDistPx
        baseFactor: 1.90,

        // L√≠mites relativos al canvas
        // minWRatio ok
        minWRatio: 0.16,

        // ‚úÖ FIX CLAVE: subir el techo.
        // Antes 0.60 -> se clavaba en el m√°ximo y ‚Äúparec√≠a‚Äù invertido al acercar.
        maxWRatio: 0.84,

        // Freno "muy cerca" usando dRatio (smoothD/canvasW)
        nearStart: 0.18,
        nearEnd:   0.28,
        nearBrake: 0.74
      };
    }

    // Desktop (NO TOCAR)
    return {
      Tpos: 0.18,
      Td: 0.16,
      Tw: 0.18,

      baseFactor: 1.85,
      minWpx: 110,
      maxWRatio: 0.30,

      nearStart: 0.18,
      nearEnd:   0.28,
      nearBrake: 0.78
    };
  }

  faceMesh.onResults((results) => {
    // 1) Si no hay video listo, salir
    if (!video.videoWidth || !video.videoHeight) return;

    // ‚úÖ 2) Detectar si es m√≥vil (UNA SOLA VEZ)
    const mobile = isMobileDevice();

    // ‚úÖ 3) Canvas estable en m√≥vil (tama√±o visible * DPR)
    if (mobile) {
      const rect = canvas.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;

      const cw = Math.max(1, Math.round(rect.width * dpr));
      const ch = Math.max(1, Math.round(rect.height * dpr));

      if (canvas.width !== cw || canvas.height !== ch) {
        canvas.width = cw;
        canvas.height = ch;
      }
    } else {
      // ‚úÖ DESKTOP: como ven√≠a (NO TOCAR)
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
    }

    // 4) Dibujar
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(results.image, 0,0,canvas.width,canvas.height);

    const faces = results.multiFaceLandmarks;
    if (!faces || !faces.length) return;

    // ‚úÖ Capas SOLO si:
    // - existe la funci√≥n
    // - y hay assets por capas cargados
    const canLayered =
      (typeof window.__drawARLayered === "function") &&
      (typeof lensAssets !== "undefined") &&
      lensAssets &&
      (lensAssets.type === "two" || lensAssets.type === "four");

    // Fallback single PNG
    if (!canLayered) {
      if (!lensImgReady || !lensImg || lensImg.naturalWidth === 0) return;
    }

    const lm = faces[0];
    const L = lm[33];
    const R = lm[263];
    const N = lm[168];

    const lx = L.x * canvas.width;
    const ly = L.y * canvas.height;
    const rx = R.x * canvas.width;
    const ry = R.y * canvas.height;
    const nx = N.x * canvas.width;
    const ny = N.y * canvas.height;

    const dx = rx - lx;
    const dy = ry - ly;

    const eyeDistPx = Math.hypot(dx, dy); // ‚úÖ m√©trica robusta
    const angle = Math.atan2(dy, dx);

    const targetX = nx;
    const targetY = ny + eyeDistPx * 0.06;

    const P = getParams(mobile);
    const scale = getLensScale();

    // suavizado pose + distancia
    if (smoothX === null) {
      smoothX = targetX;
      smoothY = targetY;
      smoothA = angle;
      smoothD = eyeDistPx;
      smoothW = null;
    } else {
      smoothX = lerp(smoothX, targetX, P.Tpos);
      smoothY = lerp(smoothY, targetY, P.Tpos);

      const da = normAngle(angle - smoothA);
      smoothA = normAngle(smoothA + da * P.Tpos);

      smoothD = lerp(smoothD, eyeDistPx, P.Td);
    }

    // =================
    // ‚úÖ ZOOM (m√≥vil vs desktop)
    // =================
    let desiredW;
    let minW, maxW;

    if (mobile) {
      // ‚úÖ M√ìVIL: usar p√≠xeles suavizados (smoothD)
      let baseW = smoothD * P.baseFactor * scale;

      // Freno suave ‚Äúmuy cerca‚Äù (evita explosi√≥n al pegar la cara)
      const dRatio = smoothD / Math.max(1, canvas.width);
      const tNearRaw = (dRatio - P.nearStart) / (P.nearEnd - P.nearStart);
      const tNear = smoothstep01(clamp01(tNearRaw));
      const brake = 1 - tNear * (1 - P.nearBrake);
      baseW *= brake;

      minW = canvas.width * P.minWRatio;
      maxW = canvas.width * P.maxWRatio;

      desiredW = softClamp(baseW, minW, maxW);

      // Debug opcional (activar: window.__DBG_ZOOM__ = true)
      if (window.__DBG_ZOOM__) {
        window.__dbgN = (window.__dbgN || 0) + 1;
        if (window.__dbgN % 15 === 0) {
          console.log("[MOBILE ZOOM]", {
            eyeDistPx: Math.round(eyeDistPx),
            smoothD: Math.round(smoothD),
            dRatio: +dRatio.toFixed(3),
            baseW: Math.round(baseW),
            desiredW: Math.round(desiredW)
          });
        }
      }

    } else {
      // ‚úÖ DESKTOP: exactamente como ven√≠a (NO TOCAR)
      let baseW = smoothD * P.baseFactor * scale;

      const dRatio = smoothD / Math.max(1, canvas.width);
      const tNearRaw = (dRatio - P.nearStart) / (P.nearEnd - P.nearStart);
      const tNear = Math.max(0, Math.min(1, tNearRaw));
      const tNearSmooth = tNear * tNear * (3 - 2 * tNear);
      const brake = 1 - tNearSmooth * (1 - P.nearBrake);
      baseW *= brake;

      minW = P.minWpx;
      maxW = canvas.width * P.maxWRatio;

      desiredW = softClamp(baseW, minW, maxW);
    }

    // ‚úÖ suavizado final del ancho (anti-temblor)
    if (smoothW === null) smoothW = desiredW;
    else smoothW = lerp(smoothW, desiredW, P.Tw);

    const targetW = smoothW;

    // =================
    // ‚úÖ DIBUJO (capas con fallback)
    // =================
    if (canLayered) {
      try {
        const res = window.__drawARLayered(ctx, { x: smoothX, y: smoothY, angle: smoothA, w: targetW });
        // si devuelve false expl√≠cito, caemos al single
        if (res !== false) return;
      } catch (e) {
        // caemos al single sin romper
      }
    }

    // fallback single
    if (!lensImgReady || !lensImg || lensImg.naturalWidth === 0) return;

    const aspect = lensImg.naturalHeight / lensImg.naturalWidth;
    const targetH = targetW * aspect;

    ctx.save();
    ctx.translate(smoothX, smoothY);
    ctx.rotate(smoothA);
    ctx.drawImage(lensImg, -targetW/2, -targetH/2, targetW, targetH);
    ctx.restore();
  });

  const camera = new Camera(video, {
    onFrame: async () => { await faceMesh.send({ image: video }); },
    width: 1280,
    height: 720,
  });

  camera.start();
}
/* =========================
     INIT
  ========================= */
  (async function () {
    try {
      console.log("INIT ‚úÖ arranc√≥");

      if (typeof loadClientConfig !== "function") {
        throw new Error("loadClientConfig() no est√° definida");
      }

      if (typeof startAR !== "function") {
        throw new Error("startAR() no est√° definida");
      }

      await loadClientConfig();
      console.log("loadClientConfig ‚úÖ OK");

      if (typeof aplicarFiltro === "function") {
        aplicarFiltro();
        console.log("aplicarFiltro ‚úÖ OK");
      } else if (typeof loadCurrentLens === "function") {
        loadCurrentLens();
        console.log("loadCurrentLens (sin filtro) ‚úÖ OK");
      }

      startAR();
      console.log("startAR ‚úÖ OK");

    } catch (e) {
      console.error("INIT ‚ùå", e);
      alert(e.message || String(e));
    }
  })();
</script>

<!-- ‚úÖ Consola en el celular (ERUDA) -->
<script src="https://cdn.jsdelivr.net/npm/eruda"></script>
<script>
  eruda.init();
  console.log("ERUDA ‚úÖ lista");
</script>

</body>
</html>