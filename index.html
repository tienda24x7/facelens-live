<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FaceLens Live</title>

  <!-- MediaPipe -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <!-- Supabase CDN (OBLIGATORIO) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { margin:0; background:#0f0f0f; color:#fff; font-family:Arial }
    #container { position:relative; width:100vw; height:100vh }
    video, canvas { position:absolute; width:100%; height:100%; object-fit:cover }
    #ui { position:fixed; bottom:0; left:0; right:0; padding:12px; background:rgba(0,0,0,.6) }
    button, select { padding:10px; border:none; border-radius:10px; font-weight:bold }
    button.secondary, select { background:#333; color:#fff }
    button.hidden { display:none }
  </style>
</head>

<body>

<div id="container">
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas"></canvas>
</div>

<div id="ui">
  <!-- Filtro -->
  <select id="categoryFilter">
    <option value="all">Todos</option>
    <option value="clasicos">ClÃ¡sicos</option>
    <option value="degrade">DegradÃ©</option>
    <option value="espejados">Espejados</option>
    <option value="polarizados">Polarizados</option>
    <option value="ferrari">Ferrari</option>
  </select>

  <!-- NavegaciÃ³n -->
  <div style="display:flex; gap:10px; margin-top:10px; align-items:center;">
    <button id="prevBtn" class="secondary">â—€</button>
    <span id="modelName" style="flex:1; text-align:center;">Cargandoâ€¦</span>
    <button id="nextBtn" class="secondary">â–¶</button>
  </div>

  <!-- Acciones -->
  <div style="margin-top:10px; display:flex; gap:10px;">
    <button id="captureBtn" class="secondary">ðŸ“¸ Captura</button>
    <button id="productBtn" class="hidden">ðŸ›’ Producto</button>
  </div>
</div>

<!-- =========================
     SUPABASE CLIENT (db)
========================= -->
<script src="./supabase.js"></script>

<!-- =========================
     APP
========================= -->
<script>
/* =========================
   1) Slug
========================= */
const slug =
  new URLSearchParams(location.search).get("slug") ||
  location.pathname.replace("/", "") ||
  "tienda24x7_demo";

/* =========================
   2) Estado
========================= */
let cliente = null;
let lentes = [];
let lentesFiltrados = [];
let currentIndex = 0;
let lensImg = new Image();
let lensImgReady = false;

/* =========================
   3) UI
========================= */
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const modelNameEl = document.getElementById("modelName");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const captureBtn = document.getElementById("captureBtn");
const productBtn = document.getElementById("productBtn");
const categoryFilter = document.getElementById("categoryFilter");

/* =========================
   4) Cargar config
========================= */
async function loadClientConfig() {
  const { data, error } = await db
    .from("lentes")
    .select("*")
    .eq("activo", true);

  if (error) throw error;

  lentes = data || [];
  if (!lentes.length) {
    lentes = [{ nombre_modelo: "Sin lentes", imagen_url: "" }];
  }
}

/* =========================
   5) Filtro
========================= */
function aplicarFiltro() {
  const cat = categoryFilter.value;

  lentesFiltrados =
    cat === "all"
      ? [...lentes]
      : lentes.filter(l => (l.categoria || "").toLowerCase() === cat);

  currentIndex = 0;
  loadCurrentLens();
}

/* =========================
   6) NavegaciÃ³n
========================= */
function loadCurrentLens() {
  if (!lentesFiltrados.length) return;

  const lens = lentesFiltrados[currentIndex];
  modelNameEl.textContent = lens.nombre_modelo || "Modelo";

  lensImgReady = false;
  if (!lens.imagen_url) return;

  lensImg = new Image();
  lensImg.crossOrigin = "anonymous";
  lensImg.src = lens.imagen_url;
  lensImg.onload = () => lensImgReady = true;

  if (lens.product_url) {
    productBtn.classList.remove("hidden");
    productBtn.onclick = () => window.open(lens.product_url, "_blank");
  } else {
    productBtn.classList.add("hidden");
  }
}

prevBtn.onclick = () => {
  currentIndex = (currentIndex - 1 + lentesFiltrados.length) % lentesFiltrados.length;
  loadCurrentLens();
};

nextBtn.onclick = () => {
  currentIndex = (currentIndex + 1) % lentesFiltrados.length;
  loadCurrentLens();
};

categoryFilter.onchange = aplicarFiltro;

captureBtn.onclick = () => {
  const a = document.createElement("a");
  a.href = canvas.toDataURL("image/png");
  a.download = "facelens.png";
  a.click();
};

/* =========================
   7) AR (simple)
========================= */
function startAR() {
  const faceMesh = new FaceMesh({
    locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`
  });

  faceMesh.setOptions({ maxNumFaces: 1, selfieMode: true });

  faceMesh.onResults(r => {
    if (!r.multiFaceLandmarks || !lensImgReady) return;
    ctx.drawImage(r.image, 0, 0, canvas.width, canvas.height);
  });

  const cam = new Camera(video, {
    onFrame: async () => faceMesh.send({ image: video })
  });
  cam.start();
}

/* =========================
   8) INIT
========================= */
(async () => {
  try {
    await loadClientConfig();
    aplicarFiltro();
    startAR();
  } catch (e) {
    console.error(e);
    alert(e.message);
  }
})();
</script>

</body>
</html>

