<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FaceLens Live</title>

  <!-- MediaPipe -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <!-- Supabase CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { margin:0; background:#0f0f0f; color:#fff; font-family:Arial }
    #container { position:relative; width:100vw; height:100vh }
    video, canvas { position:absolute; width:100%; height:100%; object-fit:cover }
    #ui { position:fixed; bottom:0; left:0; right:0; padding:12px; background:rgba(0,0,0,.6) }
    button, select { padding:10px; border:none; border-radius:10px; font-weight:bold }
    button.secondary, select { background:#333; color:#fff }
    button.hidden { display:none }
  </style>
</head>

<body>

<div id="container">
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas"></canvas>
</div>

<div id="ui">
  <select id="categoryFilter">
    <option value="all">Todos</option>
    <option value="clasicos">ClÃ¡sicos</option>
    <option value="degrade">DegradÃ©</option>
    <option value="espejados">Espejados</option>
    <option value="polarizados">Polarizados</option>
    <option value="ferrari">Ferrari</option>
  </select>

  <div style="display:flex; gap:10px; margin-top:10px; align-items:center;">
    <button id="prevBtn" class="secondary">â—€</button>
    <span id="modelName" style="flex:1; text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
      Cargandoâ€¦
    </span>
    <button id="nextBtn" class="secondary">â–¶</button>
  </div>

 <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
  <button id="captureBtn" class="secondary">ðŸ“¸ Captura</button>

  <!-- BotÃ³n 1: Ir al producto (ver ficha) -->
  <button id="productBtn" class="hidden">ðŸ”Ž Ver producto</button>

  <!-- BotÃ³n 2: Comprar (link directo al checkout / carrito si existe) -->
  <button id="buyBtn" class="hidden">ðŸ›’ Comprar</button>
</div>
</div>

<script>
const SUPABASE_URL = "https://romgbrobvperljaviekj.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJvbWdicm9idnBlcmxqYXZpZWtqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3MTQ1MTMsImV4cCI6MjA4MjI5MDUxM30.WIpN_Hj0C70bD3Q-Bnxk4tfdgJRr8NnQwmJdM3C5HuI";

const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>
/* =========================
     1) Slug
  ========================= */
  const slug =
    new URLSearchParams(location.search).get("slug") ||
    location.pathname.replace("/", "") ||
    "tienda24x7_demo";

  /* =========================
     2) Estado
  ========================= */
  let cliente = null;
  let plataformas = { web:false, whatsapp:false, redes:false };
  let links = {};
  let lentes = [];
  let lentesFiltrados = [];
  let currentIndex = 0;

  let lensImg = null;
  let lensImgReady = false;

  /* =========================
   UI
========================= */
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const modelNameEl = document.getElementById("modelName");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const captureBtn = document.getElementById("captureBtn");

const productBtn = document.getElementById("productBtn");
const buyBtn = document.getElementById("buyBtn");

const categoryFilter = document.getElementById("categoryFilter");

/* =========================
   LENTES
========================= */
function setButton(btn, visible, text, onClick) {
  if (!btn) return;
  if (!visible) {
    btn.classList.add("hidden");
    btn.onclick = null;
    return;
  }
  btn.classList.remove("hidden");
  if (text) btn.textContent = text;
  btn.onclick = onClick || null;
}

// Regla simple:
// - product_url => "Ver producto"
// - buy_url     => "Comprar" (si no existe, oculto)
// Si hoy no tenÃ©s buy_url, lo dejamos listo y no rompe nada.
function loadCurrentLens() {
  if (!lentesFiltrados.length) return;

  const lens = lentesFiltrados[currentIndex] || {};
  modelNameEl.textContent = lens.nombre_modelo || "Modelo";

  lensImgReady = false;

  // Botones de venta
  const productUrl = (lens.product_url || "").trim();
  const buyUrl = (lens.buy_url || "").trim(); // âœ… preparado para el futuro

  setButton(productBtn, !!productUrl, "ðŸ”Ž Ver producto", () => window.open(productUrl, "_blank"));
  setButton(buyBtn, !!buyUrl, "ðŸ›’ Comprar", () => window.open(buyUrl, "_blank"));

  // Imagen lente
  if (!lens.imagen_url) return;

  lensImg = new Image();
  lensImg.crossOrigin = "anonymous";
  lensImg.src = lens.imagen_url;

  lensImg.onload = () => (lensImgReady = true);
  lensImg.onerror = () => {
    lensImgReady = false;
    console.warn("No se pudo cargar imagen:", lens.imagen_url);
  };
}
  /* =========================
     4) Cargar config desde Supabase
  ========================= */
  async function loadClientConfig() {
    // 4.1 Cliente
    const { data: cData, error: cErr } = await db
      .from("clientes_facelens")
      .select("*")
      .eq("slug", slug)
      .limit(1);

    if (cErr) throw new Error("Error leyendo clientes: " + cErr.message);
    if (!cData || cData.length === 0) throw new Error(`No existe el cliente para slug: ${slug}`);

    cliente = cData[0];
    const plan = (cliente.plan || "ALL").toUpperCase().trim();

    // 4.2 Plataformas
    const { data: pData, error: pErr } = await db
      .from("plataformas")
      .select("*")
      .eq("cliente_id", cliente.id)
      .limit(1);

    if (pErr) throw new Error("Error leyendo plataformas: " + pErr.message);
    plataformas = (pData && pData[0]) || { web:false, whatsapp:false, redes:false };

    // 4.3 Links
    const { data: lData, error: lErr } = await db
      .from("links")
      .select("*")
      .eq("cliente_id", cliente.id)
      .limit(1);

    if (lErr) throw new Error("Error leyendo links: " + lErr.message);
    links = (lData && lData[0]) || {};

    // 4.4 Lentes activos (FILTRADOS POR PLAN)
    let q = db
      .from("lentes")
      .select("*")
      .eq("cliente_id", cliente.id)
      .eq("activo", true);

    if (plan === "A") q = q.eq("grupo", "A");
    else if (plan === "B") q = q.eq("grupo", "B");
    else q = q.in("grupo", ["A","B"]);

    const { data: gData, error: gErr } = await q;
    if (gErr) throw new Error("Error leyendo lentes: " + gErr.message);

    lentes = gData || [];
    if (lentes.length === 0) {
      lentes = [{ nombre_modelo: "Sin lentes cargados", imagen_url: "", categoria: "all" }];
    }

    console.log("PLAN ACTUAL:", plan);
    console.log("LENTES CARGADOS:", lentes.length);
  }

  /* =========================
     5) Lentes UI
  ========================= */
  function loadCurrentLens() {
    if (!lentesFiltrados.length) return;

    const lens = lentesFiltrados[currentIndex];
    modelNameEl.textContent = lens.nombre_modelo || "Modelo";

    lensImgReady = false;
    productBtn.classList.add("hidden");

    if (!lens.imagen_url) return;

    lensImg = new Image();
    lensImg.crossOrigin = "anonymous";
    lensImg.src = lens.imagen_url;

    lensImg.onload = () => (lensImgReady = true);
    lensImg.onerror = () => {
      lensImgReady = false;
      console.warn("No se pudo cargar imagen:", lens.imagen_url);
    };

    if (lens.product_url) {
      productBtn.classList.remove("hidden");
      productBtn.onclick = () => window.open(lens.product_url, "_blank");
    }
  }

/* =========================
   6) NavegaciÃ³n + filtro (SIN romper loadCurrentLens)
========================= */

let lentesFiltrados = [];
const categoryFilter = document.getElementById("categoryFilter");

// Aplica filtro y reinicia Ã­ndice
function aplicarFiltro() {
  const categoria = categoryFilter ? (categoryFilter.value || "all") : "all";

  if (categoria === "all") {
    lentesFiltrados = [...lentes];
  } else {
    lentesFiltrados = lentes.filter(l =>
      (l.categoria || "").toLowerCase().trim() === categoria
    );
  }

  currentIndex = 0;

  if (!lentesFiltrados.length) {
    modelNameEl.textContent = "Sin lentes en esta categorÃ­a";
    lensImgReady = false;
    if (productBtn) productBtn.classList.add("hidden");
    return;
  }

  loadCurrentLens(); // usa el override de abajo
}

// âœ… Override de loadCurrentLens SOLO para trabajar con lentesFiltrados
function loadCurrentLens() {
  if (!lentesFiltrados.length) return;

  // normaliza Ã­ndice
  currentIndex = (currentIndex + lentesFiltrados.length) % lentesFiltrados.length;

  const lens = lentesFiltrados[currentIndex] || {};
  modelNameEl.textContent = lens.nombre_modelo || "Modelo";

  lensImgReady = false;
  if (productBtn) productBtn.classList.add("hidden");

  if (!lens.imagen_url) return;

  lensImg = new Image();
  lensImg.crossOrigin = "anonymous";
  lensImg.src = lens.imagen_url;

  lensImg.onload = () => { lensImgReady = true; };
  lensImg.onerror = () => {
    lensImgReady = false;
    console.warn("No se pudo cargar imagen:", lens.imagen_url);
  };

  // BotÃ³n producto
  if (productBtn) {
    if (lens.product_url) {
      productBtn.classList.remove("hidden");
      productBtn.onclick = () => window.open(lens.product_url, "_blank");
    } else {
      productBtn.classList.add("hidden");
      productBtn.onclick = null;
    }
  }
}

// Botones navegaciÃ³n
prevBtn.onclick = () => {
  if (!lentesFiltrados.length) return;
  currentIndex = (currentIndex - 1 + lentesFiltrados.length) % lentesFiltrados.length;
  loadCurrentLens();
};

nextBtn.onclick = () => {
  if (!lentesFiltrados.length) return;
  currentIndex = (currentIndex + 1) % lentesFiltrados.length;
  loadCurrentLens();
};

// Captura
captureBtn.onclick = () => {
  const a = document.createElement("a");
  a.download = "facelens.png";
  a.href = canvas.toDataURL("image/png");
  a.click();
};

// Cambio de categorÃ­a
if (categoryFilter) {
  categoryFilter.onchange = aplicarFiltro;
}
  /* =========================
   7) AR (FaceMesh â€“ anti-temblor PRO: smoothing + deadzone + snap reset)
========================= */
function startAR() {
  const faceMesh = new FaceMesh({
    locateFile: (file) =>
      `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`,
  });

  faceMesh.setOptions({
    maxNumFaces: 1,
    refineLandmarks: true,
    minDetectionConfidence: 0.7,
    minTrackingConfidence: 0.7,
    selfieMode: true,
  });

  // Suavizado
  let sX = null, sY = null, sW = null, sH = null, sA = null;

  // MÃ¡s alto = menos temblor (mÃ¡s â€œpesadoâ€)
  const SMOOTH_POS  = 0.94;
  const SMOOTH_SIZE = 0.92;
  const SMOOTH_ANG  = 0.90;

  const lerp = (a, b, t) => a + (b - a) * t;

  function smoothAngle(prev, next, t) {
    if (prev == null) return next;
    let diff = next - prev;
    while (diff > Math.PI) diff -= Math.PI * 2;
    while (diff < -Math.PI) diff += Math.PI * 2;
    return prev + diff * t;
  }

  // Zona muerta (ignora micro-jitter)
  function deadzone(prev, next, dz) {
    if (prev == null) return next;
    return Math.abs(next - prev) < dz ? prev : next;
  }

  // Deadzone en px y radianes
  const DZ_POS_PX = 2.0;        // 1.5â€“3.0
  const DZ_SIZE_PX = 1.5;       // 1.0â€“2.5
  const DZ_ANG_RAD = 0.012;     // ~0.7Â°

  faceMesh.onResults((results) => {
    if (!video.videoWidth || !video.videoHeight) return;

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

    const faces = results.multiFaceLandmarks;
    if (!faces || faces.length === 0) {
      // Reset si se pierde la cara
      sX = sY = sW = sH = sA = null;
      return;
    }

    if (!lensImgReady || !lensImg || lensImg.naturalWidth === 0) return;

    const lm = faces[0];

    // Landmarks
    const L = lm[33];
    const R = lm[263];
    const N = lm[168];

    const lx = L.x * canvas.width;
    const ly = L.y * canvas.height;
    const rx = R.x * canvas.width;
    const ry = R.y * canvas.height;
    const nx = N.x * canvas.width;
    const ny = N.y * canvas.height;

    const dx = rx - lx;
    const dy = ry - ly;
    const eyeDist = Math.hypot(dx, dy);

    const angle = Math.atan2(dy, dx);

    // Centro: nariz + ajuste
    let targetX = nx;
    let targetY = ny + eyeDist * 0.06;

    // TamaÃ±o
    let targetW = eyeDist * 1.75;
    const aspect = lensImg.naturalHeight / lensImg.naturalWidth;
    let targetH = targetW * aspect;

    // -------- Deadzone (antes de suavizar) --------
    targetX = deadzone(sX, targetX, DZ_POS_PX);
    targetY = deadzone(sY, targetY, DZ_POS_PX);
    targetW = deadzone(sW, targetW, DZ_SIZE_PX);
    targetH = deadzone(sH, targetH, DZ_SIZE_PX);
    // Ã¡ngulo: deadzone por diferencia angular
    if (sA != null) {
      let diff = angle - sA;
      while (diff > Math.PI) diff -= Math.PI * 2;
      while (diff < -Math.PI) diff += Math.PI * 2;
      if (Math.abs(diff) < DZ_ANG_RAD) {
        // no cambia
      } else {
        // se permite
      }
    }

    // -------- Suavizado --------
    if (sX == null) {
      sX = targetX; sY = targetY; sW = targetW; sH = targetH; sA = angle;
    } else {
      const tp = 1 - SMOOTH_POS;
      const ts = 1 - SMOOTH_SIZE;
      const ta = 1 - SMOOTH_ANG;

      sX = lerp(sX, targetX, tp);
      sY = lerp(sY, targetY, tp);
      sW = lerp(sW, targetW, ts);
      sH = lerp(sH, targetH, ts);
      sA = smoothAngle(sA, angle, ta);
    }

    // Dibujo
    ctx.save();
    ctx.translate(sX, sY);
    ctx.rotate(sA);
    ctx.drawImage(lensImg, -sW / 2, -sH / 2, sW, sH);
    ctx.restore();
  });

  const camera = new Camera(video, {
    onFrame: async () => {
      await faceMesh.send({ image: video });
    },
    width: 1280,
    height: 720,
  });

  camera.start();
}
/* =========================
   8) Init
========================= */
(async function init(){
  try {
    await loadClientConfig();

    // Inicializa el filtro apenas cargan los lentes
    aplicarFiltro();

    // Arrancar AR
    startAR();

  } catch(e) {
    console.error(e);
    alert(e.message || String(e));
  }
})();
</script>

</body>
</html>
