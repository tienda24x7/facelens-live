<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FaceLens Live</title>

  <!-- MediaPipe -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <style>
    body { margin:0; background:#0f0f0f; color:#fff; font-family:Arial }
    #container { position:relative; width:100vw; height:100vh }
    video, canvas { position:absolute; width:100%; height:100%; object-fit:cover }
    #ui { position:fixed; bottom:0; left:0; right:0; padding:12px; background:rgba(0,0,0,.6) }
    button { padding:10px; border:none; border-radius:10px; font-weight:bold; cursor:pointer }
    button.secondary { background:#333; color:#fff }
    button.hidden { display:none }
  </style>
</head>

<body>

<div id="container">
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas"></canvas>
</div>

<div id="ui">
  <div>
    <button id="prevBtn" class="secondary">â—€</button>
    <span id="modelName">Cargandoâ€¦</span>
    <button id="nextBtn" class="secondary">â–¶</button>
  </div>

  <div style="margin-top:10px">
    <button id="captureBtn" class="secondary">ðŸ“¸ Captura</button>
    <button id="productBtn" class="hidden">ðŸ›’ Producto</button>
  </div>
</div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="./supabase.js"></script>

<script>
/* =========================
   0) DB
========================= */
const db = window.db;
if (!db) throw new Error("Supabase no cargado");

/* =========================
   1) Slug
========================= */
const slug =
  new URLSearchParams(location.search).get("slug") ||
  location.pathname.replace("/", "") ||
  "tienda24x7_demo";

/* =========================
   2) Estado
========================= */
let cliente = null;
let lentes = [];
let currentIndex = 0;
let lensImg = new Image();
let lensReady = false;

/* =========================
   3) UI
========================= */
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const modelNameEl = document.getElementById("modelName");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const captureBtn = document.getElementById("captureBtn");
const productBtn = document.getElementById("productBtn");

/* =========================
   4) Cargar config
========================= */
async function loadClientConfig() {

  /* Cliente */
  const { data: cData, error: cErr } = await db
    .from("clientes_facelens")

    .select("*")
    .eq("slug", slug)
    .limit(1);

  if (cErr) throw cErr;
  if (!cData.length) throw new Error("Cliente no existe");

  cliente = cData[0];
  const plan = (cliente.plan || "ALL").toUpperCase();

  console.log("PLAN ACTIVO:", plan);

  /* Lentes */
  let q = db
    .from("lentes")
    .select("*")
    .eq("cliente_id", cliente.id)
    .eq("activo", true);

  if (plan === "A") q = q.eq("grupo", "A");
  else if (plan === "B") q = q.eq("grupo", "B");
  else q = q.in("grupo", ["A","B"]); // ALL

  const { data, error } = await q;
  if (error) throw error;

  lentes = data || [];

  console.log("LENTES CARGADOS:", lentes.map(l => l.grupo));

  if (!lentes.length) {
    lentes = [{ nombre_modelo:"Sin lentes", imagen_url:"" }];
  }
}

/* =========================
   5) Lentes
========================= */
function loadCurrentLens() {
  const lens = lentes[currentIndex];
  modelNameEl.textContent = lens.nombre_modelo || "Modelo";

  if (!lens.imagen_url) return;

  lensImg = new Image();
  lensImg.crossOrigin = "anonymous";
  lensImg.src = lens.imagen_url;

  lensImg.onload = () => lensReady = true;
}

/* =========================
   6) NavegaciÃ³n
========================= */
prevBtn.onclick = () => {
  currentIndex = (currentIndex - 1 + lentes.length) % lentes.length;
  loadCurrentLens();
};
nextBtn.onclick = () => {
  currentIndex = (currentIndex + 1) % lentes.length;
  loadCurrentLens();
};

captureBtn.onclick = () => {
  const a = document.createElement("a");
  a.download = "facelens.png";
  a.href = canvas.toDataURL("image/png");
  a.click();
};

/* =========================
   7) AR (simplificado)
========================= */
function startAR() {
  function syncCanvasToVideo() {
    const vw = video.videoWidth;
    const vh = video.videoHeight;
    if (!vw || !vh) return false;

    if (canvas.width !== vw) canvas.width = vw;
    if (canvas.height !== vh) canvas.height = vh;
    return true;
  }

  const camera = new Camera(video, {
    onFrame: async () => {
      // Esperar a que el video tenga tamaÃ±o real
      if (!syncCanvasToVideo()) return;

      // Dibujar video
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      // Dibujar lente solo si la imagen estÃ¡ lista
      if (!lensImgReady || !lensImg || !lensImg.naturalWidth) return;

      // Overlay simple (igual que tu versiÃ³n, pero estable)
      ctx.drawImage(lensImg, canvas.width / 3, canvas.height / 3, 200, 80);
    }
  });

  camera.start();
}
/* =========================
   8) Init
========================= */
(async function init(){
  try {
    await loadClientConfig();
    loadCurrentLens();
    startAR();
  } catch(e) {
    console.error(e);
    alert(e.message);
  }
})();
</script>

</body>
</html>
